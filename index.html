<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Fluig - Central Dimpex de Embarques</title>
    <style>
        /* Re-use common styles */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --text-color: #333;
            --light-gray: #f8f9fa;
            --border-color: #dee2e6;
            --header-bg: #fff;
            --table-header-bg: #e9ecef;
            --shadow: 0 2px 4px rgba(0,0,0,0.05);
            --red-alert: #dc3545;
            --green-success: #28a745;
            --orange-warning: #ffc107;
            --blue-info: #17a2b8;
            --purple-status: #6f42c1;
        }
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--light-gray);
            line-height: 1.6;
            font-size: 14px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .page {
            display: none;
            width: 100%;
            flex-grow: 1;
        }
        .page.active {
            display: flex;
            flex-direction: column;
        }
        .container {
            max-width: 1200px;
            /* Removed min-width to allow more fluid responsiveness */
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: var(--shadow);
            flex-grow: 1;
        }
        .header {
            background-color: var(--header-bg);
            padding: 15px 40px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            flex-wrap: wrap; /* Allow header content to wrap on smaller screens */
            gap: 10px; /* Space between header items */
        }
        .header h1 {
            font-size: 20px;
            font-weight: 500;
            margin-bottom: 5px;
        }
        .header p {
            font-size: 13px;
            color: #666;
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap; /* Allow buttons to wrap */
            justify-content: flex-end; /* Align buttons to the right */
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out;
            white-space: nowrap;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        .btn-secondary {
            background-color: var(--secondary-color);
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out;
            white-space: nowrap;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        .input-group {
            margin-bottom: 15px;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 13px;
            font-weight: 500;
            color: #555;
        }
        .input-group select,
        .input-group input[type="text"],
        .input-group input[type="date"],
        .input-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s ease-in-out;
            box-sizing: border-box; /* Include padding and border in the element's total width and height */
            white-space: normal; /* Allow text to wrap within inputs */
            word-break: break-word; /* Break long words within inputs */
        }
        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            border-color: var(--primary-color);
        }

        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }
        .filter-group {
            flex-grow: 1;
            min-width: 200px;
        }
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            background-color: #fff;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        table thead th {
            background-color: var(--table-header-bg);
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            color: #555;
            text-transform: uppercase;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }
        table tbody td {
            padding: 10px 15px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
            vertical-align: middle;
            white-space: nowrap;
        }
        table tbody tr:hover {
            background-color: #f5f5f5;
            cursor: pointer; /* Indicate clickable rows */
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        /* Status colors */
        .status-indicator.approved { background-color: var(--green-success); }
        .status-indicator.in-production { background-color: var(--primary-color); } /* Blue */
        .status-indicator.ready-cargo { background-color: var(--orange-warning); }
        .status-indicator.atd { background-color: var(--blue-info); }
        .status-indicator.pending-doc { background-color: var(--red-alert); }
        .status-indicator.doc-ok { background-color: var(--green-success); }
        .status-indicator.ata { background-color: var(--purple-status); }
        
        /* New status colors */
        .status-indicator.booking { background-color: #ff8c00; } /* Dark Orange */
        .status-indicator.pickup { background-color: #4CAF50; } /* Green */
        .status-indicator.in-transit { background-color: #008CBA; } /* Dark Blue */
        .status-indicator.customs-clearance { background-color: #f44336; } /* Red */
        .status-indicator.released-delivery { background-color: #8A2BE2; } /* Blue Violet */
        .status-indicator.delivered { background-color: var(--green-success); } /* Green Success */

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 500px;
            position: relative;
        }
        .modal-close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            background: none;
            border: none;
            cursor: pointer;
            color: #888;
        }
        .modal-content h3 {
            margin-bottom: 20px;
            font-size: 20px;
            color: var(--primary-color);
        }
        .modal-content .input-group {
            margin-bottom: 20px;
        }
        .modal-content .modal-actions {
            margin-top: 25px;
            text-align: right;
        }

        /* Detail Screen Specific Styles */
        .form-section {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        .form-section:last-child {
            border-bottom: none;
        }
        .section-title {
            font-size: 18px;
            font-weight: 500;
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        .detail-grid {
            display: grid;
            /* Default for larger screens: 6 columns */
            grid-template-columns: repeat(6, 1fr); /* Explicitly set 6 columns */
            gap: 10px 20px; /* Keep consistent gap */
            background-color: #f8f9fa;
            padding: 2px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            width: 100%;
            justify-content: start;
            align-items: start;
        }
        .detail-item {
            display: flex;
            flex-direction: column;
            padding: 5px 0;
            /* Ensure content within item wraps */
            overflow: hidden; /* Hide overflowing content */
        }
        .detail-label {
            font-weight: 500;
            color: #555;
            margin-bottom: 3px;
            font-size: 13px;
            white-space: normal; /* Allow text to wrap */
            word-break: break-word; /* Break long words */
        }
        .detail-value {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            white-space: normal; /* Allow text to wrap */
            word-break: break-word; /* Break long words */
        }
        .detail-item input[type="text"],
        .detail-item input[type="date"],
        .detail-item textarea,
        .detail-item select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            outline: none;
            box-sizing: border-box; /* Crucial for preventing overflow */
            white-space: normal; /* Ensure input text wraps */
            word-break: break-word; /* Ensure input text breaks long words */
        }
        .detail-item input:read-only,
        .detail-item textarea:read-only {
            background-color: #e9ecef;
            cursor: not-allowed;
        }
        /* Style for items that span all columns in a 3-column grid */
        .detail-item.span-all-columns {
            grid-column: 1 / -1; /* Span from the first to the last column line */
        }


        /* Tracking Flow Styles */
        .tracking-steps {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 20px 0;
            position: relative;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: var(--shadow);
            overflow-x: auto;
            white-space: nowrap;
            min-height: 120px;
            gap: 10px; /* Space between steps */
        }

        .tracking-steps::before {
            content: '';
            position: absolute;
            top: 40px;
            left: 20px;
            right: 20px;
            height: 2px;
            background-color: #e0e0e0;
            z-index: 1;
        }

        .tracking-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            min-width: 100px;
            position: relative;
            z-index: 2;
            padding: 0 5px; /* Reduced padding */
            text-align: center;
        }

        .tracking-step .circle {
            width: 35px; /* Slightly larger */
            height: 35px; /* Slightly larger */
            border-radius: 50%;
            background-color: #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: #666;
            margin-bottom: 10px;
            flex-shrink: 0;
            border: 2px solid transparent; /* Default border */
            transition: all 0.3s ease-in-out;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* Subtle shadow for circles */
        }

        .tracking-step span {
            font-size: 11px; /* Slightly smaller font for more steps */
            text-align: center;
            color: #666;
            word-wrap: break-word;
            white-space: normal;
            transition: color 0.3s ease-in-out, font-weight 0.3s ease-in-out;
        }

        /* Status-specific styles for tracking steps */
        .tracking-step.completed .circle {
            background-color: var(--green-success);
            color: #fff;
            border-color: var(--green-success);
        }
        .tracking-step.active .circle {
            background-color: var(--primary-color);
            color: #fff;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.4); /* More prominent shadow */
        }
        .tracking-step.future .circle {
            background-color: #e0e0e0;
            color: #666;
            border-color: #e0e0e0;
        }
        
        /* Text styles for steps */
        .tracking-step.completed span {
            color: #333;
            font-weight: 500;
        }
        .tracking-step.active span {
            color: var(--primary-color);
            font-weight: bold;
        }
        .tracking-step.future span {
            color: #999;
        }

        /* Specific colors for new steps - ensure these are distinct */
        .tracking-step.booking .circle { background-color: #ff8c00; border-color: #ff8c00; } /* Dark Orange */
        .tracking-step.pickup .circle { background-color: #4CAF50; border-color: #4CAF50; } /* Green */
        .tracking-step.in-transit .circle { background-color: #008CBA; border-color: #008CBA; } /* Dark Blue */
        .tracking-step.customs-clearance .circle { background-color: #f44336; border-color: #f44336; } /* Red */
        .tracking-step.released-delivery .circle { background-color: #8A2BE2; border-color: #8A2BE2; } /* Blue Violet */
        .tracking-step.delivered .circle { background-color: var(--green-success); border-color: var(--green-success); } /* Green Success */

        .attached-files-list {
            list-style: none;
            padding: 0;
        }
        .attached-files-list li {
            background-color: #e9ecef;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }
        .attached-files-list li a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
        }
        .attached-files-list li a:hover {
            text-decoration: underline;
        }

        /* Tabs styling */
        .tabs-container {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 20px;
        }
        .tab-button {
            background-color: #f0f0f0;
            border: 1px solid var(--border-color);
            border-bottom: none;
            padding: 10px 20px;
            cursor: pointer;
            font-weight: 500;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            margin-right: 5px;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
        }
        .tab-button.active {
            background-color: var(--primary-color);
            color: #fff;
            border-color: var(--primary-color);
        }
        .tab-button:hover:not(.active) {
            background-color: #e9ecef;
        }
        .tab-content {
            display: none;
            padding-top: 10px;
        }
        .tab-content.active {
            display: block;
        }

        /* Media Queries for better responsiveness */
        @media (max-width: 1200px) { /* Adjust for slightly smaller desktops/large tablets */
            .detail-grid {
                grid-template-columns: repeat(4, 1fr); /* 4 columns */
            }
        }

        @media (max-width: 992px) { /* Adjust for tablets */
            .detail-grid {
                grid-template-columns: repeat(3, 1fr); /* 3 columns */
            }
        }

        @media (max-width: 768px) { /* Adjust for smaller tablets */
            .container {
                padding: 15px;
            }
            .header {
                flex-direction: column;
                align-items: flex-start;
                padding: 15px 20px;
            }
            .header-right {
                width: 100%;
                justify-content: center;
                margin-top: 10px;
            }
            .detail-grid {
                gap: 10px; /* Reduce gap on smaller screens */
                grid-template-columns: repeat(2, 1fr); /* 2 columns */
            }
            .tracking-steps {
                flex-wrap: wrap; /* Allow tracking steps to wrap */
                justify-content: center; /* Center steps when wrapped */
                padding: 15px 0;
            }
            .tracking-steps::before {
                display: none; /* Hide the line on very small screens if steps wrap too much */
            }
            .tracking-step {
                min-width: 80px; /* Further reduce min-width for steps */
                margin-bottom: 15px; /* Add vertical spacing when wrapped */
            }
            .tab-button {
                flex: 1; /* Make tabs take equal width */
                text-align: center;
                margin-right: 0;
                border-radius: 0;
                border-bottom: 1px solid var(--border-color);
            }
            .tabs-container {
                flex-wrap: wrap;
            }
        }

        @media (max-width: 480px) {
            .detail-grid {
                grid-template-columns: 1fr; /* Single column layout on very small screens */
            }
            .detail-item.span-all-columns {
                grid-column: auto; /* Remove span on single column layout */
            }
        }
    </style>
</head>
<body>
    <div id="dimpex-central-page" class="page active">
        <header class="header">
            <div class="header-left">
                <h1>Central Dimpex de Embarques</h1>
                <p>Gerencie e acompanhe os embarques de Hong Kong.</p>
            </div>
            <div class="header-right">
                <button class="btn-secondary" onclick="showMessage('Navegação', 'Esta ação levaria de volta à Central de Pedidos principal. (Funcionalidade de navegação simulada)')">Voltar para Central de Pedidos</button>
            </div>
        </header>

        <div class="container">
            <div class="filters">
                <div class="filter-group">
                    <label for="statusFilter">Filtrar por Status:</label>
                    <select id="statusFilter" onchange="renderDimpexOrdersTable()">
                        <option value="Todos">Todos</option>
                        <option value="Aprovado">Aprovado</option>
                        <option value="Em Produção">Em Produção</option>
                        <option value="Carga Pronta">Carga Pronta</option>
                        <option value="Reserva de Espaço (Booking)">Reserva de Espaço (Booking)</option>
                        <option value="Coleta da Carga (Pickup)">Coleta da Carga (Pickup)</option>
                        <option value="Saída do Porto de Embarque (ATD)">Saída do Porto de Embarque (ATD)</option>
                        <option value="Documentação Pendente">Documentação Pendente</option>
                        <option value="Documentação OK">Documentação OK</option>
                        <option value="Em Trânsito">Em Trânsito</option>
                        <option value="Chegada no Porto de Destino (ATA)">Chegada no Porto de Destino (ATA)</option>
                        <option value="Desembaraço Aduaneiro">Desembaraço Aduaneiro</option>
                        <option value="Liberação para Entrega">Liberação para Entrega</option>
                        <option value="Entrega ao Cliente">Entrega ao Cliente</option>
                    </select>
                </div>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Embarque</th>
                            <th>Nome Fornecedor</th>
                            <th>Número BL</th>
                            <th>Data BL</th>
                            <th>Loja Fornecedor</th>
                            <th>Pagto Ant BL</th>
                            <th>Status Dimpex</th>
                        </tr>
                    </thead>
                    <tbody id="dimpexOrdersTableBody">
                        <!-- Dimpex orders will be rendered here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Detalhes do Pedido Dimpex - Agora na mesma página -->
    <div id="dimpex-detail-page" class="page">
        <header class="header">
            <div class="header-left">
                <h1>Detalhes do Embarque: <span id="detailShipmentName"></span></h1>
                <p>Informações completas e acompanhamento do processo de importação.</p>
            </div>
            <div class="header-right">
                <button class="btn-secondary" onclick="showCentralPage()">Voltar para Central Dimpex</button>
            </div>
        </header>

        <div class="container">
            <!-- Tabs Navigation -->
            <div class="tabs-container">
                <button class="tab-button active" onclick="openTab(event, 'tabGeral')">Geral</button>
                <button class="tab-button" onclick="openTab(event, 'tabDocumentos')">Documentos</button>
                <button class="tab-button" onclick="openTab(event, 'tabFinanceiro')">Financeiro</button>
            </div>

            <!-- Tab Content: Geral -->
            <div id="tabGeral" class="tab-content active">
                <!-- Shipment Overview Section -->
                <div class="form-section">
                    <h2 class="section-title">Visão Geral do Embarque</h2>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Nº Pedido (Interno):</div>
                            <div class="detail-value" id="overviewOrderId"></div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Embarque:</div>
                            <input type="text" id="detailShipmentNameInput" readonly>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Data:</div>
                            <input type="date" id="detailShipmentDate" readonly>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Fornecedor:</div>
                            <input type="text" id="detailFornecedor" readonly>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Loja:</div>
                            <input type="text" id="detailFornecedorLoja" readonly>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">TOY Number:</div>
                            <input type="text" id="detailToyNumber" readonly>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">INCOTERM:</div>
                            <input type="text" id="detailIncoterm">
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">POL (Porto Origem):</div>
                            <input type="text" id="detailPol">
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">POD:</div>
                            <input type="text" id="detailPod">
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Prev Embarq.:</div>
                            <input type="date" id="detailPrevEmbarque">
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Pgto.Ant.BL:</div>
                            <input type="text" id="detailPagtoAntBL" readonly>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Agente Carga:</div>
                            <input type="text" id="detailCargoAgent">
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Dt Booking:</div>
                            <input type="date" id="detailDtBooking">
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Numero BL:</div>
                            <input type="text" id="detailBlNumber">
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Data BL:</div>
                            <input type="date" id="detailBlDate">
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Dt ETA:</div>
                            <input type="date" id="detailDtETA">
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Dt Finalizad:</div>
                            <input type="date" id="detailDtFinalizado">
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Contain. 20':</div>
                            <input type="text" id="detailCont20">
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Contain. 40':</div>
                            <input type="text" id="detailCont40">
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Cont. 40' HQ:</div>
                            <input type="text" id="detailCont40HQ">
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Contain. LCL:</div>
                            <input type="text" id="detailContLCL">
                        </div>
                        <div class="detail-item span-all-columns"> <!-- Added span-all-columns class -->
                            <div class="detail-label">Follow Up:</div>
                            <textarea id="detailFollowUp" rows="3"></textarea>
                        </div>
                    </div>
                    <div style="margin-top: 20px; text-align: right;">
                        <button class="btn-primary" onclick="saveShipmentDetails()">Salvar Alterações</button>
                        <button class="btn-secondary" onclick="revertToPurchase()">Estornar para Compras</button>
                    </div>
                </div>

                <!-- Status Tracking Section -->
                <div class="form-section">
                    <h2 class="section-title">Status de Rastreamento Dimpex</h2>
                    <div id="dimpexTrackingSection" class="relative flex justify-between items-center my-8 p-4 bg-gray-50 rounded-lg shadow-inner">
                        <!-- Tracking steps will be rendered here -->
                    </div>
                    <div class="input-group" style="margin-top: 20px;">
                        <label for="newStatusSelect">Atualizar Status:</label>
                        <select id="newStatusSelect">
                            <option value="Aprovado">Aprovado</option>
                            <option value="Em Produção">Em Produção</option>
                            <option value="Carga Pronta">Carga Pronta</option>
                            <option value="Reserva de Espaço (Booking)">Reserva de Espaço (Booking)</option>
                            <option value="Coleta da Carga (Pickup)">Coleta da Carga (Pickup)</option>
                            <option value="Saída do Porto de Embarque (ATD)">Saída do Porto de Embarque (ATD)</option>
                            <option value="Documentação Pendente">Documentação Pendente</option>
                            <option value="Documentação OK">Documentação OK</option>
                            <option value="Em Trânsito">Em Trânsito</option>
                            <option value="Chegada no Porto de Destino (ATA)">Chegada no Porto de Destino (ATA)</option>
                            <option value="Desembaraço Aduaneiro">Desembaraço Aduaneiro</option>
                            <option value="Liberação para Entrega">Liberação para Entrega</option>
                            <option value="Entrega ao Cliente">Entrega ao Cliente</option>
                        </select>
                        <button class="btn-primary" style="margin-top: 10px;" onclick="saveOrderStatus()">Salvar Novo Status</button>
                    </div>
                </div>

                <!-- Customs Broker Section -->
                <div class="form-section">
                    <h2 class="section-title">Informações do Despachante</h2>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Nome:</div>
                            <div class="detail-value" id="despachanteNome"></div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Contato:</div>
                            <div class="detail-value" id="despachanteContato"></div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Telefone:</div>
                            <div class="detail-value" id="despachanteTelefone"></div>
                        </div>
                    </div>
                </div>

                <!-- Product Details Section -->
                <div class="form-section">
                    <h2 class="section-title">Produtos do Pedido</h2>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Filial</th>
                                    <th>Caixas</th>
                                    <th>Descrição</th>
                                    <th>Item</th>
                                    <th>Nº Série</th>
                                    <th>Peso Bruto</th>
                                    <th>Peso Líq.</th>
                                    <th>Cód Produto</th>
                                    <th>Quantidade</th>
                                    <th>Volume m3</th>
                                    <th>Preço Unit. Venda</th>
                                    <th>Preço Unit. Compra</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody">
                                <!-- Products will be rendered here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tab Content: Documentos -->
            <div id="tabDocumentos" class="tab-content">
                <div class="form-section">
                    <h2 class="section-title">Documentos do Processo</h2>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Docs Fornece:</div>
                            <input type="text" id="docsFornecedor" readonly>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Serial Num.:</div>
                            <input type="text" id="serialNum" readonly>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Numero CI:</div>
                            <input type="text" id="numeroCI" readonly>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Numero BL:</div>
                            <input type="text" id="numeroBLDoc" readonly>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Cert.Origem:</div>
                            <input type="text" id="certOrigem" readonly>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Telex Releas:</div> <!-- Changed from Taxa Remessa -->
                            <input type="text" id="telexRelease" readonly>
                        </div>
                        <div class="detail-item span-all-columns"> <!-- Added span-all-columns class -->
                            <div class="detail-label">Remarks:</div>
                            <textarea id="remarksDoc" rows="3" readonly></textarea>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Env.Doc.Cont:</div>
                            <input type="date" id="emDocConf" readonly>
                        </div>
                    </div>
                    <div class="table-container" style="margin-top: 20px;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Documento</th>
                                    <th>Status</th>
                                    <th>Data Recebimento</th>
                                    <th>Ação</th>
                                </tr>
                            </thead>
                            <tbody id="documentsTableBody">
                                <!-- Documents will be rendered here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="form-section">
                    <h2 class="section-title">Arquivos Anexados</h2>
                    <ul id="attachedFilesList" class="attached-files-list">
                        <!-- Attached files will be rendered here -->
                    </ul>
                </div>
            </div>

            <!-- Tab Content: Financeiro -->
            <div id="tabFinanceiro" class="tab-content">
                <div class="form-section">
                    <h2 class="section-title">Informações Financeiras</h2>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Desconto:</div>
                            <input type="text" id="financeDesconto" readonly>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Tipo Descont:</div>
                            <input type="text" id="financeTipoDesconto" readonly>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Custo Extra:</div>
                            <input type="text" id="financeCustoExtra" readonly>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Tp Cust Extr:</div>
                            <input type="text" id="financeTpCustExtr" readonly>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">T/T Forneced:</div>
                            <input type="text" id="financeTitFornecedor" readonly>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Pgto Antecip:</div>
                            <input type="text" id="financePgtoAntecip" readonly>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Dt.Pg.Ant.CP:</div>
                            <input type="date" id="financeDtPgAntCP" readonly>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Pgto Sald CP:</div>
                            <input type="text" id="financePgtoSaldoCP" readonly>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Dt Pg Sal CP:</div>
                            <input type="date" id="financeDtPgSalCP" readonly>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">T/T Cliente:</div>
                            <input type="text" id="financeTitCliente" readonly>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Pg Antec CR:</div>
                            <input type="text" id="financePgAntecipCR" readonly>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Dt Pg Ant CR:</div>
                            <input type="date" id="financeDtPgAntCR" readonly>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Pg Saldo CR:</div>
                            <input type="text" id="financePgSaldoCR" readonly>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Dt Pg Sal CR:</div>
                            <input type="date" id="financeDtPgSalCR" readonly>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Mensagens (re-used from previous immersives) -->
    <div id="messageModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" id="messageModalCloseBtn">&times;</button>
            <h3 id="messageModalTitle"></h3>
            <div id="messageModalContent"></div>
            <div class="modal-actions">
                <button class="btn-primary" id="messageModalConfirmBtn">OK</button>
                <button class="btn-secondary" id="messageModalCancelBtn">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- NEW: Modal para Visualização de Documentos -->
    <div id="documentViewerModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeDocumentViewerModal()">&times;</button>
            <h3 id="documentViewerTitle"></h3>
            <pre id="documentViewerContent" style="white-space: pre-wrap; word-wrap: break-word; max-height: 70vh; overflow-y: auto; background-color: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid var(--border-color);"></pre>
            <div class="modal-actions">
                <button class="btn-primary" onclick="closeDocumentViewerModal()">Fechar</button>
            </div>
        </div>
    </div>

    <script>
        let currentDimpexOrder = null; // Global variable to hold the currently viewed order

        // Simulated data for Dimpex orders (already approved by manager)
        // This data will be stored in localStorage
        const initialDimpexOrders = [
            {
                id: 'PED-015',
                poCliente: '1127TYCH',
                fornecedor: 'Fornecedor LONCIN',
                fornecedorLoja: '01',
                cliente: 'Cliente A',
                aprovacaoDate: '2025-06-29',
                statusDimpex: 'Reserva de Espaço (Booking)', // Starting point for Dimpex
                shipmentName: 'EMB-001-CLIA', // New field
                toyNumber: 'TOY1250001', // Example TOY number
                blNumber: 'BL-HKG-001', // Example BL
                blDate: '2025-07-10', // Example BL Date
                paymentDate: '2025-08-15', // Example Payment Date (Finance)
                pol: 'Shanghai', // Port of Loading
                pod: 'Santos', // Port of Discharge
                prevEmbarque: '2025-07-05', // Editable
                dtBooking: '2025-07-01',
                dtETA: '2025-08-18',
                dtDesembaraco: '', // Will be updated
                cargoAgent: 'Agente Marítimo X', // Editable
                paymentBeforeBL: true, // Finance field (read-only)
                container20: '1',
                container40: '0',
                container40HQ: '0',
                containerLCL: '0',
                followUp: 'Primeira reserva de espaço confirmada. Aguardando coleta da carga.',
                incoterm: 'FOB', // Editable
                customsBroker: { name: 'Despachante Alfa', contact: 'contato@alfa.com', phone: '11 9876-5432' },
                documents: [
                    { name: 'Solicitação do Cliente (PED-015)', status: 'Recebido', receivedDate: '2025-06-28', fileLink: '#',
                      content: '--- Solicitação do Cliente (PED-015) ---\n\nCliente: Cliente A\nData da Solicitação: 2025-06-28\n\nItens Solicitados:\n- Motor Diesel 10HP (Modelo MX-100): 5 unidades\n\nDetalhes Adicionais:\n- Uso: Novo projeto de expansão.\n- Prioridade: Alta.\n- Observações: Necessário entrega até 2025-08-20.\n\nAtenciosamente,\nEquipe de Compras Cliente A'
                    },
                    { name: 'PO Aprovada (PED-015)', status: 'Recebido', receivedDate: '2025-06-29', fileLink: '#',
                      content: '--- Ordem de Compra Aprovada (PO-1127TYCH) ---\n\nNúmero PO: 1127TYCH\nPedido Interno: PED-015\nFornecedor: Fornecedor LONCIN (Loja 01)\nData de Aprovação: 2025-06-29\n\nItens da PO:\n- Código: PROD001\n- Descrição: Motor Diesel 10HP (Modelo MX-100)\n- Quantidade: 5 UN\n- Preço Unitário (USD): 140.00\n- Preço Unitário (BRL): 152.00\n\nCondições de Pagamento: 30 dias após data BL.\nValor Total PO: USD 700.00\n\nStatus: APROVADA\n\nGerado por: Gerência de Compras'
                    },
                    { name: 'Bill of Lading (BL)', status: 'Pendente', receivedDate: '' },
                    { name: 'Commercial Invoice', status: 'Pendente', receivedDate: '' },
                    { name: 'Packing List', status: 'Pendente', receivedDate: '' },
                    { name: 'Certificado de Origem', status: 'Pendente', receivedDate: '' }
                ],
                productLines: [
                    {
                        branch: 'SP', // New field
                        boxes: 2, // New field
                        item: 1,
                        serialNumber: 'SN-MX100-001', // New field
                        grossWeight: 150.0, // New field
                        netWeight: 140.0, // New field
                        productCode: 'PROD001',
                        description: 'Motor Diesel 10HP',
                        quantity: 5,
                        volumeM3: 0.25, // New field
                        prcUnit: 152.00,
                        prcUnitFor: 140.00
                    }
                ],
                // Document specific fields
                docsFornecedor: 'INV-2025-001',
                serialNum: 'SN-001-XYZ',
                numeroCI: 'CI-98765',
                numeroBLDoc: 'BL-HKG-001',
                certOrigem: 'CO-ABC-123',
                remarksDoc: 'Documentos iniciais recebidos e conferidos. Aguardando BL original.',
                emDocConf: '2025-07-01',
                telexRelease: 'Sim', // New field
                // Finance specific fields
                desconto: '100.00',
                tipoDesconto: 'Volume',
                custoExtra: '50.00', // Renamed from custoEntrega
                tpQualEntrega: 'Normal', // Renamed from tpQualEntrega
                titFornecedor: '23600.00',
                pgtoAntecip: '7098.00',
                dtPgAntCP: '2025-06-20',
                pgtoSaldoCP: '16502.00',
                dtPgSalCP: '2025-08-10',
                titCliente: '30256.00',
                pgAntecipCR: '9061.00',
                dtPgAntCR: '2025-07-01',
                pgSaldoCR: '20000.00',
                dtPgSalCR: '2025-09-01',
                dtFinalizado: '2025-08-25' // New field
            },
            {
                id: 'PED-019',
                poCliente: '8795MX',
                fornecedor: 'Fornecedor XY',
                fornecedorLoja: '02',
                cliente: 'Cliente B',
                aprovacaoDate: '2025-06-30',
                statusDimpex: 'Coleta da Carga (Pickup)',
                shipmentName: 'EMB-002-CLIB',
                toyNumber: 'TOY1250002',
                blNumber: '',
                blDate: '',
                paymentDate: '2025-09-01',
                pol: 'Guangzhou',
                pod: 'Paranaguá',
                prevEmbarque: '2025-07-08',
                dtBooking: '2025-07-03',
                dtETA: '2025-09-05',
                dtDesembaraco: '',
                cargoAgent: 'Logística Global',
                paymentBeforeBL: false,
                container20: '0',
                container40: '1',
                container40HQ: '0',
                containerLCL: '0',
                followUp: 'Coleta agendada para amanhã. Documentos iniciais recebidos.',
                incoterm: 'CIF',
                customsBroker: { name: 'Despachante Beta', contact: 'contato@beta.com', phone: '21 9987-6543' },
                documents: [
                    { name: 'Solicitação do Cliente (PED-019)', status: 'Recebido', receivedDate: '2025-06-29', fileLink: '#' },
                    { name: 'PO Aprovada (PED-019)', status: 'Recebido', receivedDate: '2025-06-30', fileLink: '#' },
                    { name: 'Bill of Lading (BL)', status: 'Pendente', receivedDate: '' },
                    { name: 'Commercial Invoice', status: 'Pendente', receivedDate: '' },
                    { name: 'Packing List', status: 'Pendente', receivedDate: '' },
                    { name: 'Licença de Importação', status: 'Pendente', receivedDate: '' }
                ],
                productLines: [
                    {
                        branch: 'RJ', // New field
                        boxes: 1, // New field
                        item: 1,
                        serialNumber: 'SN-GEN5000-001', // New field
                        grossWeight: 200.0, // New field
                        netWeight: 180.0, // New field
                        productCode: 'PROD002',
                        description: 'Gerador a Gasolina 5kVA',
                        quantity: 1,
                        volumeM3: 0.8, // New field
                        prcUnit: 310.00,
                        prcUnitFor: 280.00
                    }
                ],
                // Document specific fields
                docsFornecedor: 'INV-2025-002',
                serialNum: 'SN-002-ABC',
                numeroCI: 'CI-12345',
                numeroBLDoc: '',
                certOrigem: 'CO-DEF-456',
                remarksDoc: 'Aguardando coleta e emissão de BL.',
                emDocConf: '2025-07-02',
                telexRelease: 'Não', // New field
                // Finance specific fields
                desconto: '50.00',
                tipoDesconto: 'Promocional',
                custoExtra: '75.00', // Renamed from custoEntrega
                tpQualEntrega: 'Expresso', // Renamed from tpQualEntrega
                titFornecedor: '15000.00',
                pgtoAntecip: '3000.00',
                dtPgAntCP: '2025-06-25',
                pgtoSaldoCP: '12000.00',
                dtPgSalCP: '2025-08-20',
                titCliente: '18000.00',
                pgAntecipCR: '5000.00',
                dtPgAntCR: '2025-06-30',
                pgSaldoCR: '13000.00',
                dtPgSalCR: '2025-09-15',
                dtFinalizado: '' // New field
            },
            {
                id: 'PED-020',
                poCliente: '0129VO',
                fornecedor: 'Fornecedor LONCIN',
                fornecedorLoja: '01',
                cliente: 'Toyama Chile',
                aprovacaoDate: '2025-06-25',
                statusDimpex: 'Saída do Porto de Embarque (ATD)',
                shipmentName: 'EMB-003-TYCH',
                toyNumber: 'TOY1250003',
                blNumber: 'BL-HKG-002',
                blDate: '2025-07-05',
                paymentDate: '2025-08-25',
                pol: 'Ningbo',
                pod: 'Valparaíso',
                prevEmbarque: '2025-07-03',
                dtBooking: '2025-06-28',
                dtETA: '2025-08-20',
                dtDesembaraco: '',
                cargoAgent: 'TransOceanic',
                paymentBeforeBL: true,
                container20: '0',
                container40: '0',
                container40HQ: '0',
                containerLCL: '1',
                followUp: 'Carga embarcada com sucesso. BL e documentos principais recebidos.',
                incoterm: 'EXW',
                customsBroker: { name: 'Despachante Gama', contact: 'contato@gama.com', phone: '51 9765-4321' },
                documents: [
                    { name: 'Solicitação do Cliente (PED-020)', status: 'Recebido', receivedDate: '2025-06-24', fileLink: '#' },
                    { name: 'PO Aprovada (PED-020)', status: 'Recebido', receivedDate: '2025-06-25', fileLink: '#' },
                    { name: 'Bill of Lading (BL)', status: 'Recebido', receivedDate: '2025-07-01' },
                    { name: 'Commercial Invoice', status: 'Recebido', receivedDate: '2025-07-01' },
                    { name: 'Packing List', status: 'Recebido', receivedDate: '2025-07-01' }
                ],
                productLines: [
                    {
                        branch: 'MG', // New field
                        boxes: 5, // New field
                        item: 1,
                        serialNumber: 'SN-MINIPUMP-001', // New field
                        grossWeight: 15.0, // New field
                        netWeight: 12.0, // New field
                        productCode: 'PROD003',
                        description: 'Mini Bomba D\'água',
                        quantity: 15,
                        volumeM3: 0.1, // New field
                        prcUnit: 22.00,
                        prcUnitFor: 20.00
                    }
                ],
                // Document specific fields
                docsFornecedor: 'INV-2025-003',
                serialNum: 'SN-003-DEF',
                numeroCI: 'CI-67890',
                numeroBLDoc: 'BL-HKG-002',
                certOrigem: 'CO-GHI-789',
                remarksDoc: 'Todos os documentos de embarque recebidos.',
                emDocConf: '2025-07-05',
                telexRelease: 'Sim', // New field
                // Finance specific fields
                desconto: '20.00',
                tipoDesconto: 'Quantidade',
                custoExtra: '30.00', // Renamed from custoEntrega
                tpQualEntrega: 'Padrão', // Renamed from tpQualEntrega
                titFornecedor: '5000.00',
                pgtoAntecip: '1000.00',
                dtPgAntCP: '2025-06-20',
                pgtoSaldoCP: '4000.00',
                dtPgSalCP: '2025-08-01',
                titCliente: '6000.00',
                pgAntecipCR: '2000.00',
                dtPgAntCR: '2025-06-25',
                pgSaldoCR: '4000.00',
                dtPgSalCR: '2025-08-15',
                dtFinalizado: '' // New field
            },
            {
                id: 'PED-025',
                poCliente: '4040JKL',
                fornecedor: 'Fornecedor XY',
                fornecedorLoja: '02',
                cliente: 'Cliente G',
                aprovacaoDate: '2025-07-05',
                statusDimpex: 'Em Trânsito',
                shipmentName: 'EMB-004-CLIG',
                toyNumber: 'TOY1250004',
                blNumber: 'BL-HKG-003',
                blDate: '2025-07-12',
                paymentDate: '2025-09-20',
                pol: 'Shanghai',
                pod: 'Manaus',
                prevEmbarque: '2025-07-10',
                dtBooking: '2025-07-08',
                dtETA: '2025-10-20',
                dtDesembaraco: '',
                cargoAgent: 'Ocean Freight',
                paymentBeforeBL: false,
                container20: '0',
                container40: '1',
                container40HQ: '0',
                containerLCL: '0',
                followUp: 'Navio a caminho. Monitorando a ETA.',
                incoterm: 'FOB',
                customsBroker: { name: 'Despachante Theta', contact: 'contato@theta.com', phone: '91 9456-7890' },
                documents: [
                    { name: 'Solicitação do Cliente (PED-025)', status: 'Recebido', receivedDate: '2025-07-04', fileLink: '#' },
                    { name: 'PO Aprovada (PED-025)', status: 'Recebido', receivedDate: '2025-07-05', fileLink: '#' },
                    { name: 'Bill of Lading (BL)', status: 'Recebido', receivedDate: '2025-07-12' },
                    { name: 'Commercial Invoice', status: 'Recebido', receivedDate: '2025-07-12' },
                    { name: 'Packing List', status: 'Recebido', receivedDate: '2025-07-12' }
                ],
                productLines: [
                    {
                        branch: 'SP', // New field
                        boxes: 1, // New field
                        item: 1,
                        serialNumber: 'SN-GEN5000-002', // New field
                        grossWeight: 200.0, // New field
                        netWeight: 180.0, // New field
                        productCode: 'PROD002',
                        description: 'Gerador a Gasolina 5kVA',
                        quantity: 2,
                        volumeM3: 0.8, // New field
                        prcUnit: 2500.00,
                        prcUnitFor: 1200.00
                    }
                ],
                // Document specific fields
                docsFornecedor: 'INV-2025-004',
                serialNum: 'SN-004-GHI',
                numeroCI: 'CI-11223',
                numeroBLDoc: 'BL-HKG-003',
                certOrigem: 'CO-JKL-012',
                remarksDoc: 'Em trânsito. Acompanhando a localização do navio.',
                emDocConf: '2025-07-12',
                telexRelease: 'Não', // New field
                // Finance specific fields
                desconto: '0.00',
                tipoDesconto: 'Nenhum',
                custoExtra: '100.00', // Renamed from custoEntrega
                tpQualEntrega: 'Normal', // Renamed from tpQualEntrega
                titFornecedor: '24000.00',
                pgtoAntecip: '0.00',
                dtPgAntCP: '',
                pgtoSaldoCP: '24000.00',
                dtPgSalCP: '2025-09-10',
                titCliente: '30000.00',
                pgAntecipCR: '0.00',
                dtPgAntCR: '',
                pgSaldoCR: '30000.00',
                dtPgSalCR: '2025-10-05',
                dtFinalizado: '' // New field
            },
            {
                id: 'PED-026',
                poCliente: '5050MNO',
                fornecedor: 'Fornecedor LONCIN',
                fornecedorLoja: '01',
                cliente: 'Cliente H',
                aprovacaoDate: '2025-07-06',
                statusDimpex: 'Chegada no Porto de Destino (ATA)',
                shipmentName: 'EMB-005-CLIh',
                toyNumber: 'TOY1250005',
                blNumber: 'BL-HKG-004',
                blDate: '2025-07-15',
                paymentDate: '2025-10-01',
                pol: 'Ningbo',
                pod: 'Salvador',
                prevEmbarque: '2025-07-13',
                dtBooking: '2025-07-10',
                dtETA: '2025-10-25',
                dtDesembaraco: '',
                cargoAgent: 'Sea Cargo',
                paymentBeforeBL: true,
                container20: '0',
                container40: '0',
                container40HQ: '0',
                containerLCL: '1',
                followUp: 'Carga chegou ao porto. Aguardando início do desembaraço.',
                incoterm: 'CFR',
                customsBroker: { name: 'Despachante Iota', contact: 'contato@iota.com', phone: '71 9678-9012' },
                documents: [
                    { name: 'Solicitação do Cliente (PED-026)', status: 'Recebido', receivedDate: '2025-07-05', fileLink: '#' },
                    { name: 'PO Aprovada (PED-026)', status: 'Recebido', receivedDate: '2025-07-06', fileLink: '#' },
                    { name: 'Bill of Lading (BL)', status: 'Recebido', receivedDate: '2025-07-15' },
                    { name: 'Commercial Invoice', status: 'Recebido', receivedDate: '2025-07-15' },
                    { name: 'Packing List', status: 'Recebido', receivedDate: '2025-07-15' }
                ],
                productLines: [
                    {
                        branch: 'BA', // New field
                        boxes: 3, // New field
                        item: 1,
                        serialNumber: 'SN-MINIPUMP-002', // New field
                        grossWeight: 10.0, // New field
                        netWeight: 8.0, // New field
                        productCode: 'PROD003',
                        description: 'Mini Bomba D\'água',
                        quantity: 10,
                        volumeM3: 0.08, // New field
                        prcUnit: 250.00,
                        prcUnitFor: 120.00
                    }
                ],
                // Document specific fields
                docsFornecedor: 'INV-2025-005',
                serialNum: 'SN-005-MNO',
                numeroCI: 'CI-44556',
                numeroBLDoc: 'BL-HKG-004',
                certOrigem: 'CO-PQR-345',
                remarksDoc: 'Carga no porto de destino. Preparando documentação para alfândega.',
                emDocConf: '2025-07-15',
                telexRelease: 'Sim', // New field
                // Finance specific fields
                desconto: '15.00',
                tipoDesconto: 'Fidelidade',
                custoExtra: '20.00', // Renamed from custoEntrega
                tpQualEntrega: 'Padrão', // Renamed from tpQualEntrega
                titFornecedor: '12000.00',
                pgtoAntecip: '2500.00',
                dtPgAntCP: '2025-07-01',
                pgtoSaldoCP: '9500.00',
                dtPgSalCP: '2025-09-20',
                titCliente: '14000.00',
                pgAntecipCR: '4000.00',
                dtPgAntCR: '2025-07-06',
                pgSaldoCR: '10000.00',
                dtPgSalCR: '2025-10-10',
                dtFinalizado: '' // New field
            },
            {
                id: 'PED-027',
                poCliente: '6060PQR',
                fornecedor: 'Fornecedor XY',
                fornecedorLoja: '02',
                cliente: 'Cliente I',
                aprovacaoDate: '2025-07-07',
                statusDimpex: 'Desembaraço Aduaneiro',
                shipmentName: 'EMB-006-CLII',
                toyNumber: 'TOY1250006',
                blNumber: 'BL-HKG-005',
                blDate: '2025-07-18',
                paymentDate: '2025-10-05',
                pol: 'Guangzhou',
                pod: 'Fortaleza',
                prevEmbarque: '2025-07-16',
                dtBooking: '2025-07-14',
                dtETA: '2025-11-01',
                dtDesembaraco: '2025-07-25', // Example date
                cargoAgent: 'Porto Forte',
                paymentBeforeBL: false,
                container20: '1',
                container40: '0',
                container40HQ: '0',
                containerLCL: '0',
                followUp: 'Documentos entregues ao despachante. Desembaraço em andamento.',
                incoterm: 'DAP',
                customsBroker: { name: 'Despachante Kappa', contact: 'contato@kappa.com', phone: '85 9123-4567' },
                documents: [
                    { name: 'Solicitação do Cliente (PED-027)', status: 'Recebido', receivedDate: '2025-07-06', fileLink: '#' },
                    { name: 'PO Aprovada (PED-027)', status: 'Recebido', receivedDate: '2025-07-07', fileLink: '#' },
                    { name: 'Bill of Lading (BL)', status: 'Recebido', receivedDate: '2025-07-18' },
                    { name: 'Commercial Invoice', status: 'Recebido', receivedDate: '2025-07-18' },
                    { name: 'Packing List', status: 'Recebido', receivedDate: '2025-07-18' },
                    { name: 'Certificado de Conformidade', status: 'Pendente', receivedDate: '' }
                ],
                productLines: [
                    {
                        branch: 'CE', // New field
                        boxes: 1, // New field
                        item: 1,
                        serialNumber: 'SN-MX100-003', // New field
                        grossWeight: 150.0, // New field
                        netWeight: 140.0, // New field
                        productCode: 'PROD001',
                        description: 'Motor Diesel 10HP',
                        quantity: 3,
                        volumeM3: 0.25, // New field
                        prcUnit: 1500.00,
                        prcUnitFor: 800.00
                    }
                ],
                // Document specific fields
                docsFornecedor: 'INV-2025-006',
                serialNum: 'SN-006-STU',
                numeroCI: 'CI-77889',
                numeroBLDoc: 'BL-HKG-005',
                certOrigem: 'CO-VWX-678',
                remarksDoc: 'Desembaraço aduaneiro em fase final. Aguardando liberação.',
                emDocConf: '2025-07-20',
                telexRelease: 'Não', // New field
                // Finance specific fields
                desconto: '0.00',
                tipoDesconto: 'Nenhum',
                custoExtra: '40.00', // Renamed from custoEntrega
                tpQualEntrega: 'Padrão', // Renamed from tpQualEntrega
                titFornecedor: '24000.00',
                pgtoAntecip: '00.00',
                dtPgAntCP: '',
                pgtoSaldoCP: '24000.00',
                dtPgSalCP: '2025-09-25',
                titCliente: '28000.00',
                pgAntecipCR: '0.00',
                dtPgAntCR: '',
                pgSaldoCR: '28000.00',
                dtPgSalCR: '2025-10-20',
                dtFinalizado: '' // New field
            },
            {
                id: 'PED-028',
                poCliente: '7070STU',
                fornecedor: 'Fornecedor LONCIN',
                fornecedorLoja: '01',
                cliente: 'Cliente J',
                aprovacaoDate: '2025-07-08',
                statusDimpex: 'Liberação para Entrega',
                shipmentName: 'EMB-007-CLIJ',
                toyNumber: 'TOY1250007',
                blNumber: 'BL-HKG-006',
                blDate: '2025-07-20',
                paymentDate: '2025-10-10',
                pol: 'Foshan',
                pod: 'Goiânia',
                prevEmbarque: '2025-07-18',
                dtBooking: '2025-07-16',
                dtETA: '2025-11-05',
                dtDesembaraco: '2025-07-28',
                cargoAgent: 'Carga Rápida',
                paymentBeforeBL: true,
                container20: '0',
                container40: '1',
                container40HQ: '0',
                containerLCL: '0',
                followUp: 'Carga liberada pela alfândega. Aguardando agendamento de transporte final.',
                incoterm: 'DDP',
                customsBroker: { name: 'Despachante Lambda', contact: 'contato@lambda.com', phone: '62 9876-5432' },
                documents: [
                    { name: 'Solicitação do Cliente (PED-028)', status: 'Recebido', receivedDate: '2025-07-07', fileLink: '#' },
                    { name: 'PO Aprovada (PED-028)', status: 'Recebido', receivedDate: '2025-07-08', fileLink: '#' },
                    { name: 'Bill of Lading (BL)', status: 'Recebido', receivedDate: '2025-07-20' },
                    { name: 'Commercial Invoice', status: 'Recebido', receivedDate: '2025-07-20' },
                    { name: 'Packing List', status: 'Recebido', receivedDate: '2025-07-20' },
                    { name: 'Comprovante de Pagamento de Impostos', status: 'Recebido', receivedDate: '2025-07-20' }
                ],
                productLines: [
                    {
                        branch: 'GO', // New field
                        boxes: 1, // New field
                        item: 1,
                        serialNumber: 'SN-GEN5000-004', // New field
                        grossWeight: 200.0, // New field
                        netWeight: 180.0, // New field
                        productCode: 'PROD002',
                        description: 'Gerador a Gasolina 5kVA',
                        quantity: 1,
                        volumeM3: 0.8, // New field
                        prcUnit: 2500.00,
                        prcUnitFor: 1200.00
                    }
                ],
                // Document specific fields
                docsFornecedor: 'INV-2025-007',
                serialNum: 'SN-007-ABC',
                numeroCI: 'CI-99887',
                numeroBLDoc: 'BL-HKG-006',
                certOrigem: 'CO-DEF-901',
                remarksDoc: 'Carga liberada. Coordenando transporte terrestre.',
                emDocConf: '2025-07-28',
                telexRelease: 'Sim', // New field
                // Finance specific fields
                desconto: '0.00',
                tipoDesconto: 'Nenhum',
                custoExtra: '60.00', // Renamed from custoEntrega
                tpQualEntrega: 'Expresso', // Renamed from tpQualEntrega
                titFornecedor: '12000.00',
                pgtoAntecip: '0.00',
                dtPgAntCP: '',
                pgtoSaldoCP: '12000.00',
                dtPgSalCP: '2025-10-01',
                titCliente: '15000.00',
                pgAntecipCR: '0.00',
                dtPgAntCR: '',
                pgSaldoCR: '15000.00',
                dtPgSalCR: '2025-11-01',
                dtFinalizado: '' // New field
            },
            {
                id: 'PED-029',
                poCliente: '8080VWX',
                fornecedor: 'Fornecedor XY',
                fornecedorLoja: '02',
                cliente: 'Cliente K',
                aprovacaoDate: '2025-07-09',
                statusDimpex: 'Entrega ao Cliente',
                shipmentName: 'EMB-008-CLIK',
                toyNumber: 'TOY1250008',
                blNumber: 'BL-HKG-007',
                blDate: '2025-07-22',
                paymentDate: '2025-10-15',
                pol: 'Shenzhen',
                pod: 'São Paulo',
                prevEmbarque: '2025-07-20',
                dtBooking: '2025-07-18',
                dtETA: '2025-11-10',
                dtDesembaraco: '2025-07-30',
                cargoAgent: 'Transportadora Expressa',
                paymentBeforeBL: true,
                container20: '0',
                container40: '0',
                container40HQ: '0',
                containerLCL: '1',
                followUp: 'Carga entregue com sucesso ao cliente. Processo finalizado.',
                incoterm: 'FOB',
                customsBroker: { name: 'Despachante Mu', contact: 'contato@mu.com', phone: '11 9111-2222' },
                documents: [
                    { name: 'Solicitação do Cliente (PED-029)', status: 'Recebido', receivedDate: '2025-07-08', fileLink: '#' },
                    { name: 'PO Aprovada (PED-029)', status: 'Recebido', receivedDate: '2025-07-09', fileLink: '#' },
                    { name: 'Bill of Lading (BL)', status: 'Recebido', receivedDate: '2025-07-22' },
                    { name: 'Commercial Invoice', status: 'Recebido', receivedDate: '2025-07-22' },
                    { name: 'Packing List', status: 'Recebido', receivedDate: '2025-07-22' },
                    { name: 'Comprovante de Entrega', status: 'Recebido', receivedDate: '2025-07-22' }
                ],
                productLines: [
                    {
                        branch: 'SP', // New field
                        boxes: 2, // New field
                        item: 1,
                        serialNumber: 'SN-MINIPUMP-003', // New field
                        grossWeight: 15.0, // New field
                        netWeight: 12.0, // New field
                        productCode: 'PROD003',
                        description: 'Mini Bomba D\'água',
                        quantity: 5,
                        volumeM3: 0.1, // New field
                        prcUnit: 250.00,
                        prcUnitFor: 120.00
                    }
                ],
                // Document specific fields
                docsFornecedor: 'INV-2025-008',
                serialNum: 'SN-008-CDE',
                numeroCI: 'CI-11334',
                numeroBLDoc: 'BL-HKG-007',
                certOrigem: 'CO-FGH-234',
                remarksDoc: 'Entrega finalizada. Processo concluído.',
                emDocConf: '2025-07-30',
                telexRelease: 'Sim', // New field
                // Finance specific fields
                desconto: '25.00',
                tipoDesconto: 'Liquidação',
                custoExtra: '15.00', // Renamed from custoEntrega
                tpQualEntrega: 'Padrão', // Renamed from tpQualEntrega
                titFornecedor: '6000.00',
                pgtoAntecip: '1500.00',
                dtPgAntCP: '2025-07-05',
                pgtoSaldoCP: '4500.00',
                dtPgSalCP: '2025-10-01',
                titCliente: '7500.00',
                pgAntecipCR: '2000.00',
                dtPgAntCR: '2025-07-10',
                pgSaldoCR: '5500.00',
                dtPgSalCR: '2025-11-05',
                dtFinalizado: '2025-07-31' // New field
            }
        ];

        // This variable will hold the actual data for Dimpex orders, loaded from localStorage
        let dimpexOrders = [];

        // Define the Dimpex tracking flow explicitly
        const dimpexTrackingFlow = [
            { name: 'Aprovado', class: 'approved', description: 'Pedido aprovado pela Gerência, aguardando início do processo Dimpex.' },
            { name: 'Em Produção', class: 'in-production', description: 'Fornecedor iniciou a produção dos itens.' },
            { name: 'Carga Pronta', class: 'ready-cargo', description: 'Mercadoria pronta para embarque na origem.' },
            { name: 'Reserva de Espaço (Booking)', class: 'booking', description: 'Espaço no navio reservado.' },
            { name: 'Coleta da Carga (Pickup)', class: 'pickup', fun: 'collectCargo', description: 'Carga coletada do fornecedor.' },
            { name: 'Saída do Porto de Embarque (ATD)', class: 'atd', description: 'Carga embarcada e saiu do porto de origem.' },
            { name: 'Documentação Pendente', class: 'pending-doc', description: 'Aguardando recebimento e conferência de documentos do despachante.' },
            { name: 'Documentação OK', class: 'doc-ok', description: 'Todos os documentos recebidos e validados.' },
            { name: 'Em Trânsito', class: 'in-transit', description: 'Navio com a carga está em trânsito.' },
            { name: 'Chegada no Porto de Destino (ATA)', class: 'ata', description: 'Navio chegou ao porto de destino.' },
            { name: 'Desembaraço Aduaneiro', class: 'customs-clearance', description: 'Processo de desembaraço aduaneiro em andamento.' },
            { name: 'Liberação para Entrega', class: 'released-delivery', description: 'Carga liberada para transporte ao cliente.' },
            { name: 'Entrega ao Cliente', class: 'delivered', description: 'Mercadoria entregue ao cliente.' }
        ];

        function showMessage(title, content, type = 'info', onConfirm = null, onCancel = null) {
            const modal = document.getElementById('messageModal');
            document.getElementById('messageModalTitle').innerText = title;
            document.getElementById('messageModalContent').innerHTML = content;
            const confirmBtn = document.getElementById('messageModalConfirmBtn');
            const cancelBtn = document.getElementById('messageModalCancelBtn');
            const closeBtn = document.getElementById('messageModalCloseBtn');

            confirmBtn.onclick = () => { if (onConfirm) onConfirm(); modal.classList.remove('active'); };
            cancelBtn.onclick = () => { if (onCancel) onCancel(); modal.classList.remove('active'); };
            closeBtn.onclick = () => modal.classList.remove('active');

            confirmBtn.classList.add('hidden');
            cancelBtn.classList.add('hidden');
            closeBtn.classList.remove('hidden');

            if (onConfirm || onCancel) {
                closeBtn.classList.add('hidden');
                confirmBtn.classList.remove('hidden');
                if (onCancel) {
                    cancelBtn.classList.remove('hidden');
                }
            }
            modal.classList.add('active');
        }

        // Functions to control page visibility
        function showCentralPage() {
            document.getElementById('dimpex-detail-page').classList.remove('active');
            document.getElementById('dimpex-central-page').classList.add('active');
            renderDimpexOrdersTable(); // Re-render table when returning to central view
        }

        function showDetailPage(orderId) {
            const order = dimpexOrders.find(o => o.id === orderId);
            if (order) {
                currentDimpexOrder = order;
                document.getElementById('dimpex-central-page').classList.remove('active');
                document.getElementById('dimpex-detail-page').classList.add('active');
                renderDimpexOrderDetails(); // Render details for the selected order
            } else {
                showMessage('Erro', 'Embarque não encontrado.', 'error');
            }
        }

        function renderDimpexOrdersTable() {
            const tbody = document.getElementById('dimpexOrdersTableBody');
            tbody.innerHTML = '';

            const statusFilter = document.getElementById('statusFilter').value;

            let filteredOrders = dimpexOrders.filter(order => {
                return statusFilter === 'Todos' || order.statusDimpex === statusFilter;
            });

            if (filteredOrders.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 20px;">Nenhum embarque encontrado para o status selecionado.</td></tr>`;
                return;
            }

            filteredOrders.forEach(order => {
                const row = document.createElement('tr');
                // Call showDetailPage directly with the order ID
                row.onclick = () => showDetailPage(order.id);

                let statusClass = '';
                // Determine the status class based on the order's statusDimpex
                const flowStep = dimpexTrackingFlow.find(step => step.name === order.statusDimpex);
                if (flowStep) {
                    statusClass = flowStep.class;
                }
                
                row.innerHTML = `
                    <td>${order.aprovacaoDate || 'N/A'}</td>
                    <td>${order.shipmentName || 'N/A'}</td>
                    <td>${order.fornecedor || 'N/A'}</td>
                    <td>${order.blNumber || 'N/A'}</td>
                    <td>${order.blDate || 'N/A'}</td>
                    <td>${order.fornecedorLoja || 'N/A'}</td>
                    <td>${order.paymentBeforeBL ? 'Sim' : 'Não'}</td>
                    <td><span class="status-indicator ${statusClass}"></span>${order.statusDimpex}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Helper function to safely get element value
        const safeGetValue = (id) => {
            const element = document.getElementById(id);
            return element ? element.value : ''; // Return empty string if element is null
        };

        function renderDimpexOrderDetails() {
            if (!currentDimpexOrder) {
                showMessage('Erro', 'Nenhum embarque selecionado. Retornando à Central Dimpex.', 'error', () => {
                    showCentralPage();
                });
                return;
            }

            // Helper function to safely set element value
            const safeSetValue = (id, value) => {
                const element = document.getElementById(id);
                if (element) {
                    element.value = value || '';
                } else {
                    console.warn(`Element with ID '${id}' not found. Cannot set its value.`);
                }
            };

            // Helper function to safely set element innerText
            const safeSetText = (id, text) => {
                const element = document.getElementById(id);
                if (element) {
                    element.innerText = text || 'N/A';
                } else {
                    console.warn(`Element with ID '${id}' not found. Cannot set its text.`);
                }
            };

            // Populate Shipment Overview (Geral Tab)
            safeSetText('detailShipmentName', currentDimpexOrder.shipmentName);
            safeSetText('overviewOrderId', currentDimpexOrder.id);
            safeSetValue('detailShipmentNameInput', currentDimpexOrder.shipmentName);
            safeSetValue('detailShipmentDate', currentDimpexOrder.aprovacaoDate);
            safeSetValue('detailFornecedor', currentDimpexOrder.fornecedor);
            safeSetValue('detailFornecedorLoja', currentDimpexOrder.fornecedorLoja);
            safeSetValue('detailToyNumber', currentDimpexOrder.toyNumber);
            safeSetValue('detailIncoterm', currentDimpexOrder.incoterm); // Editable
            safeSetValue('detailPol', currentDimpexOrder.pol); // Editable
            safeSetValue('detailPod', currentDimpexOrder.pod); // Editable
            safeSetValue('detailPrevEmbarque', currentDimpexOrder.prevEmbarque); // Editable
            safeSetValue('detailPagtoAntBL', currentDimpexOrder.paymentBeforeBL ? 'Sim' : 'Não'); // Read-only
            safeSetValue('detailCargoAgent', currentDimpexOrder.cargoAgent); // Editable
            safeSetValue('detailDtBooking', currentDimpexOrder.dtBooking);
            safeSetValue('detailBlNumber', currentDimpexOrder.blNumber);
            safeSetValue('detailBlDate', currentDimpexOrder.blDate);
            safeSetValue('detailDtETA', currentDimpexOrder.dtETA);
            safeSetValue('detailDtDesembaraco', currentDimpexOrder.dtDesembaraco);
            safeSetValue('detailDtFinalizado', currentDimpexOrder.dtFinalizado); // New field

            // Ensure container values are strings, even if they are numbers in data
            safeSetValue('detailCont20', String(currentDimpexOrder.container20 || ''));
            safeSetValue('detailCont40', String(currentDimpexOrder.container40 || ''));
            safeSetValue('detailCont40HQ', String(currentDimpexOrder.container40HQ || ''));
            safeSetValue('detailContLCL', String(currentDimpexOrder.containerLCL || ''));

            safeSetValue('detailFollowUp', currentDimpexOrder.followUp); // Editable

            // Populate Status Tracking (Geral Tab)
            renderTracking(currentDimpexOrder.statusDimpex);
            safeSetValue('newStatusSelect', currentDimpexOrder.statusDimpex); // Set current status in dropdown

            // Populate Customs Broker Info (Geral Tab)
            if (currentDimpexOrder.customsBroker) {
                safeSetText('despachanteNome', currentDimpexOrder.customsBroker.name);
                safeSetText('despachanteContato', currentDimpexOrder.customsBroker.contact);
                safeSetText('despachanteTelefone', currentDimpexOrder.customsBroker.phone);
            } else {
                safeSetText('despachanteNome', 'N/A');
                safeSetText('despachanteContato', 'N/A');
                safeSetText('despachanteTelefone', 'N/A');
            }

            // Populate Product Details (Geral Tab)
            renderProductsTable();

            // Populate Document Tab fields
            safeSetValue('docsFornecedor', currentDimpexOrder.docsFornecedor);
            safeSetValue('serialNum', currentDimpexOrder.serialNum);
            safeSetValue('numeroCI', currentDimpexOrder.numeroCI);
            safeSetValue('numeroBLDoc', currentDimpexOrder.numeroBLDoc);
            safeSetValue('certOrigem', currentDimpexOrder.certOrigem);
            safeSetValue('remarksDoc', currentDimpexOrder.remarksDoc);
            safeSetValue('emDocConf', currentDimpexOrder.emDocConf);
            safeSetValue('telexRelease', currentDimpexOrder.telexRelease); // New field
            renderDocumentsTable(); // Render the dynamic documents table
            renderAttachedFiles(); // Render the attached files list

            // Populate Finance Tab fields
            safeSetValue('financeDesconto', currentDimpexOrder.desconto);
            safeSetValue('financeTipoDesconto', currentDimpexOrder.tipoDesconto);
            safeSetValue('financeCustoExtra', currentDimpexOrder.custoExtra); // Renamed
            safeSetValue('financeTpCustExtr', currentDimpexOrder.tpQualEntrega); // Renamed
            safeSetValue('financeTitFornecedor', currentDimpexOrder.titFornecedor);
            safeSetValue('financePgtoAntecip', currentDimpexOrder.pgtoAntecip);
            safeSetValue('financeDtPgAntCP', currentDimpexOrder.dtPgAntCP);
            safeSetValue('financePgtoSaldoCP', currentDimpexOrder.pgtoSaldoCP);
            safeSetValue('financeDtPgSalCP', currentDimpexOrder.dtPgSalCP);
            safeSetValue('financeTitCliente', currentDimpexOrder.titCliente);
            safeSetValue('financePgAntecipCR', currentDimpexOrder.pgAntecipCR);
            safeSetValue('financeDtPgAntCR', currentDimpexOrder.dtPgAntCR);
            safeSetValue('financePgSaldoCR', currentDimpexOrder.pgSaldoCR);
            safeSetValue('financeDtPgSalCR', currentDimpexOrder.dtPgSalCR);

            // Ensure the "Geral" tab is active by default when opening details
            openTab(null, 'tabGeral');
        }

        function renderTracking(currentStatus) {
            const trackingSection = document.getElementById('dimpexTrackingSection');
            trackingSection.innerHTML = '';

            let currentStatusIndex = dimpexTrackingFlow.findIndex(step => step.name === currentStatus);

            let trackingHtml = '<div class="tracking-steps">';

            dimpexTrackingFlow.forEach((step, index) => {
                let stepClass = '';
                let circleContent = '';

                if (index < currentStatusIndex) {
                    stepClass = 'completed';
                } else if (index === currentStatusIndex) {
                    stepClass = 'active';
                } else {
                    stepClass = 'future';
                }
                
                // Add specific class for styling based on the step's predefined class
                if (step.class) {
                    stepClass += ` ${step.class}`;
                }

                if (stepClass.includes('completed')) {
                    circleContent = '&#10003;'; // Checkmark
                } else if (stepClass.includes('active')) {
                    circleContent = (index + 1).toString();
                }

                trackingHtml += `
                    <div class="tracking-step ${stepClass}">
                        <div class="circle">${circleContent}</div>
                        <span>${step.name}</span>
                    </div>
                `;
            });
            trackingHtml += '</div>';
            trackingSection.innerHTML = trackingHtml;
        }

        function saveOrderStatus() {
            if (!currentDimpexOrder) {
                showMessage('Erro', 'Nenhum embarque carregado.', 'error');
                return;
            }

            const newStatus = document.getElementById('newStatusSelect').value;

            // Update the status in the currentDimpexOrder object
            currentDimpexOrder.statusDimpex = newStatus;

            // Update localStorage to reflect the change for persistence across pages
            let allDimpexOrders = JSON.parse(localStorage.getItem('dimpexOrders')) || [];
            const orderIndex = allDimpexOrders.findIndex(order => order.id === currentDimpexOrder.id);
            if (orderIndex !== -1) {
                allDimpexOrders[orderIndex] = currentDimpexOrder;
                localStorage.setItem('dimpexOrders', JSON.stringify(allDimpexOrders));
            } else {
                allDimpexOrders.push(currentDimpexOrder);
                localStorage.setItem('dimpexOrders', JSON.stringify(allDimpexOrders));
            }

            showMessage('Sucesso', `Status do embarque ${currentDimpexOrder.shipmentName} atualizado para "${newStatus}"!`, 'success', () => {
                renderDimpexOrderDetails(); // Re-render details to show updated status
            });
        }

        function saveShipmentDetails() {
            if (!currentDimpexOrder) {
                showMessage('Erro', 'Nenhum embarque carregado para salvar os detalhes.', 'error');
                return;
            }

            // Update editable fields from the form using safeGetValue
            currentDimpexOrder.shipmentName = safeGetValue('detailShipmentNameInput');
            currentDimpexOrder.incoterm = safeGetValue('detailIncoterm');
            currentDimpexOrder.pol = safeGetValue('detailPol');
            currentDimpexOrder.pod = safeGetValue('detailPod');
            currentDimpexOrder.prevEmbarque = safeGetValue('detailPrevEmbarque');
            currentDimpexOrder.cargoAgent = safeGetValue('detailCargoAgent');
            currentDimpexOrder.dtBooking = safeGetValue('detailDtBooking');
            currentDimpexOrder.blNumber = safeGetValue('detailBlNumber');
            currentDimpexOrder.blDate = safeGetValue('detailBlDate');
            currentDimpexOrder.dtETA = safeGetValue('detailDtETA');
            currentDimpexOrder.dtDesembaraco = safeGetValue('detailDtDesembaraco');
            currentDimpexOrder.dtFinalizado = safeGetValue('detailDtFinalizado');
            currentDimpexOrder.container20 = safeGetValue('detailCont20');
            currentDimpexOrder.container40 = safeGetValue('detailCont40');
            currentDimpexOrder.container40HQ = safeGetValue('detailCont40HQ');
            currentDimpexOrder.containerLCL = safeGetValue('detailContLCL');
            currentDimpexOrder.followUp = safeGetValue('detailFollowUp');

            // Update localStorage to reflect the change for persistence
            let allDimpexOrders = JSON.parse(localStorage.getItem('dimpexOrders')) || [];
            const orderIndex = allDimpexOrders.findIndex(order => order.id === currentDimpexOrder.id);
            if (orderIndex !== -1) {
                allDimpexOrders[orderIndex] = currentDimpexOrder;
                localStorage.setItem('dimpexOrders', JSON.stringify(allDimpexOrders));
            }

            showMessage('Sucesso', `Detalhes do embarque ${currentDimpexOrder.shipmentName} salvos com sucesso!`, 'success', () => {
                renderDimpexOrderDetails(); // Re-render details to show updated values
            });
        }

        function revertToPurchase() {
            if (!currentDimpexOrder) {
                showMessage('Erro', 'Nenhum embarque carregado para estornar.', 'error');
                return;
            }

            showMessage(
                'Confirmação',
                `Tem certeza que deseja estornar o embarque ${currentDimpexOrder.shipmentName} para o status "Aprovado" (Compras)?`,
                'warning',
                () => {
                    currentDimpexOrder.statusDimpex = 'Aprovado'; // Set status back to "Aprovado"
                    // Update localStorage
                    let allDimpexOrders = JSON.parse(localStorage.getItem('dimpexOrders')) || [];
                    const orderIndex = allDimpexOrders.findIndex(order => order.id === currentDimpexOrder.id);
                    if (orderIndex !== -1) {
                        allDimpexOrders[orderIndex] = currentDimpexOrder;
                        localStorage.setItem('dimpexOrders', JSON.stringify(allDimpexOrders));
                    }
                    showMessage('Sucesso', `Embarque ${currentDimpexOrder.shipmentName} estornado para "Aprovado" com sucesso!`, 'success', () => {
                        showCentralPage(); // Go back to central page after reverting
                    });
                },
                () => {
                    // User cancelled, do nothing
                }
            );
        }

        function renderAttachedFiles() {
            const ul = document.getElementById('attachedFilesList');
            ul.innerHTML = '';

            if (!currentDimpexOrder || !currentDimpexOrder.documents || currentDimpexOrder.documents.length === 0) {
                ul.innerHTML = `<li>Nenhum arquivo anexado.</li>`;
                return;
            }

            currentDimpexOrder.documents.forEach(doc => {
                const li = document.createElement('li');
                let buttonsHtml = '';

                // Add "Visualizar" button if content exists
                if (doc.content) {
                    buttonsHtml += `<button class="btn-primary" onclick="viewAttachedFile('${currentDimpexOrder.id}', '${doc.name}')">Visualizar</button>`;
                }

                // Add "Extrair" button if status is 'Recebido' AND content exists
                if (doc.status === 'Recebido' && doc.content) {
                    buttonsHtml += `<button class="btn-primary" style="margin-left: 10px;" onclick="extractAttachedFile('${currentDimpexOrder.id}', '${doc.name}')">Extrair</button>`;
                }

                li.innerHTML = `
                    <span>${doc.name}</span>
                    <div>${buttonsHtml}</div>
                `;
                ul.appendChild(li);
            });
        }

        function viewAttachedFile(orderId, docName) {
            const order = dimpexOrders.find(o => o.id === orderId);
            if (!order) {
                showMessage('Erro', 'Embarque não encontrado para visualizar o documento.', 'error');
                return;
            }
            const doc = order.documents.find(d => d.name === docName);
            if (doc && doc.content) {
                document.getElementById('documentViewerTitle').innerText = doc.name;
                document.getElementById('documentViewerContent').innerText = doc.content;
                document.getElementById('documentViewerModal').classList.add('active');
            } else {
                showMessage('Erro', `Conteúdo do documento "${docName}" não disponível para visualização.`, 'error');
            }
        }

        function extractAttachedFile(orderId, docName) {
            const order = dimpexOrders.find(o => o.id === orderId);
            if (!order) {
                showMessage('Erro', 'Embarque não encontrado para extrair o documento.', 'error');
                return;
            }
            const doc = order.documents.find(d => d.name === docName);
            if (doc && doc.content && doc.status === 'Recebido') {
                try {
                    const blob = new Blob([doc.content], { type: 'text/plain;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    // Sanitize filename for download
                    const fileName = doc.name.replace(/[^a-z0-9\s-]/gi, '').replace(/\s+/g, '-').toLowerCase() + '.txt';
                    a.download = fileName;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showMessage('Sucesso', `Documento "${docName}" extraído com sucesso!`, 'success');
                } catch (e) {
                    console.error('Erro ao extrair documento:', e);
                    showMessage('Erro', `Não foi possível extrair o documento "${docName}".`, 'error');
                }
            } else {
                showMessage('Erro', `O documento "${docName}" não pode ser extraído. Verifique se ele foi recebido e possui conteúdo.`, 'error');
            }
        }

        function closeDocumentViewerModal() {
            document.getElementById('documentViewerModal').classList.remove('active');
        }


        function renderDocumentsTable() {
            const tbody = document.getElementById('documentsTableBody');
            tbody.innerHTML = '';

            if (!currentDimpexOrder || !currentDimpexOrder.documents || currentDimpexOrder.documents.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" style="text-align: center; padding: 15px;">Nenhum documento cadastrado para este embarque.</td></tr>`;
                return;
            }

            currentDimpexOrder.documents.forEach((doc, index) => {
                const row = document.createElement('tr');
                const actionButton = doc.status === 'Pendente' ?
                    `<button class="btn-primary" onclick="receiveDocument('${doc.name}', ${index})">Receber Documento</button>` :
                    `<button class="btn-secondary" disabled>Recebido</button>`;

                row.innerHTML = `
                    <td>${doc.name}</td>
                    <td><span class="status-indicator ${doc.status === 'Pendente' ? 'pending-doc' : 'doc-ok'}"></span>${doc.status}</td>
                    <td>${doc.receivedDate || 'N/A'}</td>
                    <td>${actionButton}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function receiveDocument(docName, index) {
            if (!currentDimpexOrder || !currentDimpexOrder.documents) return;

            currentDimpexOrder.documents[index].status = 'Recebido';
            currentDimpexOrder.documents[index].receivedDate = new Date().toISOString().slice(0, 10);

            // Update localStorage
            let allDimpexOrders = JSON.parse(localStorage.getItem('dimpexOrders')) || [];
            const orderIndex = allDimpexOrders.findIndex(order => order.id === currentDimpexOrder.id);
            if (orderIndex !== -1) {
                allDimpexOrders[orderIndex] = currentDimpexOrder;
                localStorage.setItem('dimpexOrders', JSON.stringify(allDimpexOrders));
            }

            showMessage('Sucesso', `Documento "${docName}" recebido com sucesso!`, 'success', () => {
                renderDocumentsTable(); // Re-render documents table
                renderAttachedFiles(); // Re-render attached files to show "Extrair" button
            });
        }

        function renderProductsTable() {
            const tbody = document.getElementById('productsTableBody');
            tbody.innerHTML = '';

            if (!currentDimpexOrder || !currentDimpexOrder.productLines || currentDimpexOrder.productLines.length === 0) {
                tbody.innerHTML = `<tr><td colspan="12" style="text-align: center; padding: 15px;">Nenhum produto associado a este embarque.</td></tr>`;
                return;
            }

            currentDimpexOrder.productLines.forEach(product => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${product.branch || 'N/A'}</td>
                    <td>${product.boxes || 'N/A'}</td>
                    <td>${product.description || 'N/A'}</td>
                    <td>${product.item || 'N/A'}</td>
                    <td>${product.serialNumber || 'N/A'}</td>
                    <td>${(product.grossWeight !== undefined && product.grossWeight !== null) ? product.grossWeight.toFixed(2).replace('.', ',') : 'N/A'}</td>
                    <td>${(product.netWeight !== undefined && product.netWeight !== null) ? product.netWeight.toFixed(2).replace('.', ',') : 'N/A'}</td>
                    <td>${product.productCode || 'N/A'}</td>
                    <td>${product.quantity || 'N/A'} ${product.unitMeasure || ''}</td>
                    <td>${(product.volumeM3 !== undefined && product.volumeM3 !== null) ? product.volumeM3.toFixed(3).replace('.', ',') : 'N/A'}</td>
                    <td>R$ ${(product.prcUnit !== undefined && product.prcUnit !== null) ? product.prcUnit.toFixed(2).replace('.', ',') : 'N/A'}</td>
                    <td>R$ ${(product.prcUnitFor !== undefined && product.prcUnitFor !== null) ? product.prcUnitFor.toFixed(2).replace('.', ',') : 'N/A'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Function to handle tab switching
        function openTab(evt, tabName) {
            let i, tabcontent, tabbuttons;

            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].classList.remove("active");
            }

            tabbuttons = document.getElementsByClassName("tab-button");
            for (i = 0; i < tabbuttons.length; i++) {
                tabbuttons[i].classList.remove("active");
            }

            document.getElementById(tabName).classList.add("active");
            if (evt) {
                evt.currentTarget.classList.add("active");
            } else {
                // If called without an event (e.g., on initial load), activate the corresponding button
                const activeButton = Array.from(tabbuttons).find(button => button.innerText.includes(tabName === 'tabGeral' ? 'Geral' : tabName === 'tabDocumentos' ? 'Documentos' : 'Financeiro'));
                if (activeButton) {
                    activeButton.classList.add('active');
                }
            }
        }


        // Initial load when the page is opened
        document.addEventListener('DOMContentLoaded', () => {
            // Load all dimpex orders from localStorage, or use initial data if not found
            const storedAllOrders = localStorage.getItem('dimpexOrders');
            if (storedAllOrders) {
                dimpexOrders = JSON.parse(storedAllOrders);
            } else {
                dimpexOrders = initialDimpexOrders;
                localStorage.setItem('dimpexOrders', JSON.stringify(initialDimpexOrders));
            }
            showCentralPage(); // Start by showing the central page
        });
    </script>
</body>
</html>
