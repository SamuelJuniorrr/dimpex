<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Fluig - Central Dimpex de Embarques</title>
    <!-- Incluindo html2pdf.js via CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* Re-use common styles */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --text-color: #333;
            --light-gray: #f8f9fa;
            --border-color: #dee2e6;
            --header-bg: #fff;
            --table-header-bg: #e9ecef;
            --shadow: 0 2px 4px rgba(0,0,0,0.05);
            --red-alert: #dc3545;
            --green-success: #28a745;
            --orange-warning: #ffc107;
            --blue-info: #17a2b8;
            --purple-status: #6f42c1;
        }
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--light-gray);
            line-height: 1.6;
            font-size: 14px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .page {
            display: none;
            width: 100%;
            flex-grow: 1;
        }
        .page.active {
            display: flex;
            flex-direction: column;
        }
        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: var(--shadow);
            flex-grow: 1;
        }
        .header {
            background-color: var(--header-bg);
            padding: 15px 40px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            flex-wrap: wrap;
            gap: 10px;
        }
        .header h1 {
            font-size: 20px;
            font-weight: 500;
            margin-bottom: 5px;
        }
        .header p {
            font-size: 13px;
            color: #666;
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out;
            white-space: nowrap;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        .btn-secondary {
            background-color: var(--secondary-color);
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out;
            white-space: nowrap;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        .input-group {
            margin-bottom: 15px;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 13px;
            font-weight: 500;
            color: #555;
        }
        .input-group select,
        .input-group input[type="text"],
        .input-group input[type="date"],
        .input-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s ease-in-out;
            box-sizing: border-box;
            white-space: normal;
            word-break: break-word;
        }
        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            border-color: var(--primary-color);
        }

        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }
        .filter-group {
            flex-grow: 1;
            min-width: 200px;
        }
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            background-color: #fff;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        table thead th {
            background-color: var(--table-header-bg);
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            color: #555;
            text-transform: uppercase;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }
        table tbody td {
            padding: 10px 15px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
            vertical-align: middle;
            white-space: nowrap;
        }
        table tbody tr:hover {
            background-color: #f5f5f5;
            cursor: pointer;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        /* Status colors */
        .status-indicator.approved { background-color: var(--green-success); }
        .status-indicator.in-production { background-color: var(--primary-color); }
        .status-indicator.ready-cargo { background-color: var(--orange-warning); }
        .status-indicator.atd { background-color: var(--blue-info); }
        .status-indicator.pending-doc { background-color: var(--red-alert); }
        .status-indicator.doc-ok { background-color: var(--green-success); }
        .status-indicator.ata { background-color: var(--purple-status); }
        
        /* New status colors */
        .status-indicator.booking { background-color: #ff8c00; }
        .status-indicator.pickup { background-color: #4CAF50; }
        .status-indicator.in-transit { background-color: #008CBA; }
        .status-indicator.customs-clearance { background-color: #f44336; }
        .status-indicator.released-delivery { background-color: #8A2BE2; }
        .status-indicator.delivered { background-color: var(--green-success); border-color: var(--green-success); }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 500px;
            position: relative;
        }
        .modal-close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            background: none;
            border: none;
            cursor: pointer;
            color: #888;
        }
        .modal-content h3 {
            margin-bottom: 20px;
            font-size: 20px;
            color: var(--primary-color);
        }
        .modal-content .input-group {
            margin-bottom: 20px;
        }
        .modal-content .modal-actions {
            margin-top: 25px;
            text-align: right;
        }

        /* Detail Screen Specific Styles */
        .form-section {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        .form-section:last-child {
            border-bottom: none;
        }
        .section-title {
            font-size: 18px;
            font-weight: 500;
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px 20px;
            background-color: #f8f9fa;
            padding: 2px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            width: 100%;
            justify-content: start;
            align-items: start;
        }
        .detail-item {
            display: flex;
            flex-direction: column;
            padding: 5px 0;
            overflow: hidden;
        }
        .detail-label {
            font-weight: 500;
            color: #555;
            margin-bottom: 3px;
            font-size: 13px;
            white-space: normal;
            word-break: break-word;
        }
        .detail-value {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            white-space: normal;
            word-break: break-word;
        }
        .detail-item input[type="text"],
        .detail-item input[type="date"],
        .detail-item textarea,
        .detail-item select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            outline: none;
            box-sizing: border-box;
            white-space: normal;
            word-break: break-word;
        }
        .detail-item input:read-only,
        .detail-item textarea:read-only {
            background-color: #e9ecef;
            cursor: not-allowed;
        }
        .detail-item.span-all-columns {
            grid-column: 1 / -1;
        }

        /* Follow Up section with button */
        .followup-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
            grid-column: 1 / -1; /* This item will span all columns */
        }
        .followup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        .followup-header .detail-label {
            margin-bottom: 0; /* Remove bottom margin from label in flex container */
        }
        .followup-textarea-wrapper {
            width: 100%;
        }


        /* Tracking Flow Styles */
        .tracking-steps {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 20px 0;
            position: relative;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: var(--shadow);
            overflow-x: auto;
            white-space: nowrap;
            min-height: 120px;
            gap: 10px;
        }

        .tracking-steps::before {
            content: '';
            position: absolute;
            top: 40px;
            left: 20px;
            right: 20px;
            height: 2px;
            background-color: #e0e0e0;
            z-index: 1;
        }

        .tracking-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            min-width: 100px;
            position: relative;
            z-index: 2;
            padding: 0 5px;
            text-align: center;
        }

        .tracking-step .circle {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background-color: #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: #666;
            margin-bottom: 10px;
            flex-shrink: 0;
            border: 2px solid transparent;
            transition: all 0.3s ease-in-out;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .tracking-step span {
            font-size: 11px;
            text-align: center;
            color: #666;
            word-wrap: break-word;
            white-space: normal;
            transition: color 0.3s ease-in-out, font-weight 0.3s ease-in-out;
        }

        .tracking-step.completed .circle {
            background-color: var(--green-success);
            color: #fff;
            border-color: var(--green-success);
        }
        .tracking-step.active .circle {
            background-color: var(--primary-color);
            color: #fff;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.4);
        }
        .tracking-step.future .circle {
            background-color: #e0e0e0;
            color: #666;
            border-color: #e0e0e0;
        }
        
        .tracking-step.completed span {
            color: #333;
            font-weight: 500;
        }
        .tracking-step.active span {
            color: var(--primary-color);
            font-weight: bold;
        }
        .tracking-step.future span {
            color: #999;
        }

        .attached-files-list {
            list-style: none;
            padding: 0;
        }
        .attached-files-list li {
            background-color: #e9ecef;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }
        .attached-files-list li a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
        }
        .attached-files-list li a:hover {
            text-decoration: underline;
        }

        /* Tabs styling */
        .tabs-container {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 20px;
        }
        .tab-button {
            background-color: #f0f0f0;
            border: 1px solid var(--border-color);
            border-bottom: none;
            padding: 10px 20px;
            cursor: pointer;
            font-weight: 500;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            margin-right: 5px;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
        }
        .tab-button.active {
            background-color: var(--primary-color);
            color: #fff;
            border-color: var(--primary-color);
        }
        .tab-button:hover:not(.active) {
            background-color: #e9ecef;
        }
        .tab-content {
            display: none;
            padding-top: 10px;
        }
        .tab-content.active {
            display: block;
        }

        /* Dashboard Specific Styles - Compacted */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        .kpi-card {
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            text-align: center;
            border: 1px solid var(--border-color);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .kpi-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .kpi-card .value {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 3px;
        }
        .kpi-card .label {
            font-size: 13px;
            color: #666;
            font-weight: 500;
        }

        .form-section {
            margin-bottom: 10px;
            padding-bottom: 5px;
        }
        .section-title {
            margin-bottom: 10px;
        }

        /* Styles for the PDF generation content (hidden by default) */
        #pdfContentContainer {
            display: none; /* Hidden by default */
            width: 190mm; /* A4 width */
            min-height: 270mm; /* A4 height */
            background-color: #fff;
            padding: 10mm; /* Adjusted padding to give more space */
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
            font-size: 10pt;
            color: #333;
        }
        #pdfContentContainer .header-section {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            border-bottom: 1px solid #000;
            padding-bottom: 10px;
        }
        #pdfContentContainer .header-left {
            flex: 1;
            display: flex;
            align-items: center;
        }
        #pdfContentContainer .header-left img {
            height: 50px;
            margin-right: 10px;
        }
        #pdfContentContainer .company-info {
            font-size: 8pt;
            line-height: 1.2;
        }
        #pdfContentContainer .header-right {
            text-align: right;
            font-size: 14pt; /* Reduced font size to prevent cutting off */
            font-weight: bold;
            color: #000;
            flex: 1;
        }
        #pdfContentContainer .section-box {
            border: 1px solid #000;
            margin-bottom: 15px;
            padding: 5px;
            /* Ensure content inside can expand vertically */
            overflow: visible; /* Added to ensure content is not hidden */
        }
        #pdfContentContainer .section-title {
            background-color: #e0e0e0;
            padding: 3px 5px;
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 9pt;
        }
        #pdfContentContainer .section-content {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 5px 10px;
            padding: 5px;
        }
        #pdfContentContainer .section-content.three-cols {
            grid-template-columns: repeat(3, 1fr);
        }
        #pdfContentContainer .section-content.single-col {
            grid-template-columns: 1fr;
        }
        /* Ensure text in single-column sections wraps */
        #pdfContentContainer .section-content.single-col .item-value,
        #pdfContentContainer .section-content.single-col .item-row {
            white-space: normal;
            word-break: break-word;
            height: auto; /* Ensure height adjusts to content */
            min-height: 20px; /* Minimum height for better rendering */
        }

        #pdfContentContainer .item-label {
            font-weight: bold;
            font-size: 8pt;
        }
        #pdfContentContainer .item-value {
            font-size: 9pt;
        }
        #pdfContentContainer .item-row {
            display: flex;
            gap: 5px;
            align-items: baseline;
        }
        #pdfContentContainer .item-row.full-width {
            grid-column: 1 / -1;
        }
        #pdfContentContainer .products-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        #pdfContentContainer .products-table th, #pdfContentContainer .products-table td {
            border: 1px solid #000;
            padding: 5px;
            text-align: left;
            font-size: 8pt;
        }
        #pdfContentContainer .products-table th {
            background-color: #e0e0e0;
            font-weight: bold;
            text-align: center;
        }
        #pdfContentContainer .products-table td {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #pdfContentContainer .products-table .qty, #pdfContentContainer .products-table .pkgs, #pdfContentContainer .products-table .nw, #pdfContentContainer .products-table .gw, #pdfContentContainer .products-table .cbm {
            text-align: center;
        }
        #pdfContentContainer .footer-text {
            margin-top: 30px;
            font-size: 8pt;
            text-align: center;
            border-top: 1px solid #000;
            padding-top: 10px;
        }
        #pdfContentContainer .highlight-box {
            border: 1px solid #000;
            padding: 5px;
            font-size: 8pt;
            font-weight: bold;
            background-color: #ffffcc;
            margin-bottom: 15px;
        }
        #pdfContentContainer .top-right-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        #pdfContentContainer .top-right-info > div {
            border: 1px solid #000;
            padding: 5px;
            flex: 1;
            margin-left: 10px;
            font-size: 9pt;
        }
        #pdfContentContainer .top-right-info > div:first-child {
            margin-left: 0;
        }
        #pdfContentContainer .top-right-info .label {
            font-weight: bold;
            margin-bottom: 3px;
        }
        #pdfContentContainer .top-right-info .value {
            white-space: nowrap;
        }


        /* Media Queries for better responsiveness */
        @media (max-width: 1200px) {
            .detail-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 992px) {
            .detail-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            .followup-section {
                flex-direction: column;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            .header {
                flex-direction: column;
                align-items: flex-start;
                padding: 15px 20px;
            }
            .header-right {
                width: 100%;
                justify-content: center;
                margin-top: 10px;
            }
            .detail-grid {
                gap: 10px;
                grid-template-columns: repeat(2, 1fr);
            }
            .tracking-steps {
                flex-wrap: wrap;
                justify-content: center;
                padding: 15px 0;
            }
            .tracking-steps::before {
                display: none;
            }
            .tracking-step {
                min-width: 80px;
                margin-bottom: 15px;
            }
            .tab-button {
                flex: 1;
                text-align: center;
                margin-right: 0;
                border-radius: 0;
                border-bottom: 1px solid var(--border-color);
            }
            .tabs-container {
                flex-wrap: wrap;
            }
        }

        @media (max-width: 480px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            .detail-grid {
                grid-template-columns: 1fr;
            }
            .detail-item.span-all-columns {
                grid-column: auto;
            }
            .followup-section {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div id="dimpex-central-page" class="page active">
        <header class="header">
            <div class="header-left">
                <h1>Central Dimpex de Embarques</h1>
                <p>Gerencie e acompanhe os embarques de Hong Kong.</p>
            </div>
        </header>

        <div class="container">
            <div class="form-section">
                <h2 class="section-title">Visão Geral do Dashboard</h2>
                <div class="dashboard-grid">
                    <div class="kpi-card">
                        <div class="value" id="totalShipmentsKPI">0</div>
                        <div class="label">Total de Embarques</div>
                    </div>
                    <div class="kpi-card">
                        <div class="value" id="inTransitShipmentsKPI">0</div>
                        <div class="label">Em Trânsito</div>
                    </div>
                    <div class="kpi-card">
                        <div class="value" id="customsClearanceShipmentsKPI">0</div>
                        <div class="label">Desembaraço Aduaneiro</div>
                    </div>
                    <div class="kpi-card">
                        <div class="value" id="deliveredShipmentsKPI">0</div>
                        <div class="label">Entregues ao Cliente</div>
                    </div>
                </div>
            </div>

            <div class="filters">
                <div class="filter-group">
                    <label for="statusFilter">Filtrar por Status:</label>
                    <select id="statusFilter" onchange="renderDimpexOrdersTable()">
                        <option value="Todos">Todos</option>
                        <option value="Aprovado">Aprovado</option>
                        <option value="Em Produção">Em Produção</option>
                        <option value="Carga Pronta">Carga Pronta</option>
                        <option value="Reserva de Espaço (Booking)">Reserva de Espaço (Booking)</option>
                        <option value="Saída do Porto de Embarque (ATD)">Saída do Porto de Embarque (ATD)</option>
                        <option value="Documentação Pendente">Documentação Pendente</option>
                        <option value="Documentação OK">Documentação OK</option>
                        <option value="Em Trânsito">Em Trânsito</option>
                        <option value="Chegada no Porto de Destino (ATA)">Chegada no Porto de Destino (ATA)</option>
                        <option value="Entrega ao Cliente">Entrega ao Cliente</option>
                    </select>
                </div>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Embarque</th>
                            <th>Nome Fornecedor</th>
                            <th>Número BL</th>
                            <th>Data BL</th>
                            <th>Loja Fornecedor</th>
                            <th>Pagto Ant BL</th>
                            <th>Status Dimpex</th>
                        </tr>
                    </thead>
                    <tbody id="dimpexOrdersTableBody">
                        <!-- Dimpex orders will be rendered here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Detalhes do Pedido Dimpex -->
    <div id="dimpex-detail-page" class="page">
        <header class="header">
            <div class="header-left">
                <h1>Detalhes do Embarque: <span id="detailShipmentName"></span></h1>
                <p>Informações completas e acompanhamento do processo de importação.</p>
            </div>
            <div class="header-right">
                <button class="btn-secondary" onclick="showCentralPage()">Voltar para Central Dimpex</button>
            </div>
        </header>

        <div class="container">
            <!-- Tabs Navigation for Detail Page -->
            <div class="tabs-container">
                <button class="tab-button active" onclick="openTab(event, 'tabGeral')">Geral</button>
                <button class="tab-button" onclick="openTab(event, 'tabDocumentos')">Documentos</button>
                <button class="tab-button" onclick="openTab(event, 'tabFinanceiro')">Financeiro</button>
            </div>

            <!-- Tab Content: Geral -->
            <div id="tabGeral" class="tab-content active">
                <!-- Shipment Overview Section -->
                <div class="form-section">
                    <h2 class="section-title">Visão Geral do Embarque</h2>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Nº Pedido (Interno):</div>
                            <div class="detail-value" id="overviewOrderId"></div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Embarque:</div>
                            <input type="text" id="detailShipmentNameInput" readonly>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Data:</div>
                            <input type="date" id="detailShipmentDate" readonly>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Fornecedor:</div>
                            <input type="text" id="detailFornecedor" readonly>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Loja:</div>
                            <input type="text" id="detailFornecedorLoja" readonly>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">TOY Number:</div>
                            <input type="text" id="detailToyNumber" readonly>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">INCOTERM:</div>
                            <input type="text" id="detailIncoterm">
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">POL (Porto Origem):</div>
                            <input type="text" id="detailPol">
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">POD:</div>
                            <input type="text" id="detailPod">
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Prev Embarq.:</div>
                            <input type="date" id="detailPrevEmbarque">
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Pgto.Ant.BL:</div>
                            <input type="text" id="detailPagtoAntBL" readonly>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Agente Carga:</div>
                            <input type="text" id="detailCargoAgent">
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Dt Booking:</div>
                            <input type="date" id="detailDtBooking">
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Numero BL:</div>
                            <input type="text" id="detailBlNumber">
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Data BL:</div>
                            <input type="date" id="detailBlDate">
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Dt ETA:</div>
                            <input type="date" id="detailDtETA">
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Dt Finalizad:</div>
                            <input type="date" id="detailDtFinalizado">
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Contain. 20':</div>
                            <input type="text" id="detailCont20">
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Contain. 40':</div>
                            <input type="text" id="detailCont40">
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Cont. 40' HQ:</div>
                            <input type="text" id="detailCont40HQ">
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Contain. LCL:</div>
                            <input type="text" id="detailContLCL">
                        </div>
                        
                        <!-- Follow Up Section with PDF Button -->
                        <div class="followup-section">
                            <div class="followup-header">
                                <div class="detail-label">Follow Up:</div>
                                <button class="btn-primary" onclick="generatePdfFollowUp()">Gerar PDF</button>
                            </div>
                            <div class="followup-textarea-wrapper">
                                <textarea id="detailFollowUp" rows="5"></textarea>
                            </div>
                        </div>

                    </div>
                    <div style="margin-top: 20px; text-align: right;">
                        <button class="btn-primary" onclick="saveShipmentDetails()">Salvar Alterações</button>
                        <button class="btn-secondary" onclick="revertToPurchase()">Estornar para Compras</button>
                    </div>
                </div>

                <!-- Status Tracking Section -->
                <div class="form-section">
                    <h2 class="section-title">Status de Rastreamento Dimpex</h2>
                    <div id="dimpexTrackingSection" class="relative flex justify-between items-center my-8 p-4 bg-gray-50 rounded-lg shadow-inner">
                        <!-- Tracking steps will be rendered here -->
                    </div>
                    <div class="input-group" style="margin-top: 20px;">
                        <label for="newStatusSelect">Atualizar Status:</label>
                        <select id="newStatusSelect">
                            <option value="Aprovado">Aprovado</option>
                            <option value="Em Produção">Em Produção</option>
                            <option value="Carga Pronta">Carga Pronta</option>
                            <option value="Reserva de Espaço (Booking)">Reserva de Espaço (Booking)</option>
                            <option value="Saída do Porto de Embarque (ATD)">Saída do Porto de Embarque (ATD)</option>
                            <option value="Documentação Pendente">Documentação Pendente</option>
                            <option value="Documentação OK">Documentação OK</option>
                            <option value="Em Trânsito">Em Trânsito</option>
                            <option value="Chegada no Porto de Destino (ATA)">Chegada no Porto de Destino (ATA)</option>
                            <option value="Entrega ao Cliente">Entrega ao Cliente</option>
                        </select>
                        <button class="btn-primary" style="margin-top: 10px;" onclick="saveOrderStatus()">Salvar Novo Status</button>
                    </div>
                </div>

                <!-- Customs Broker Section -->
                <div class="form-section">
                    <h2 class="section-title">Informações do Despachante</h2>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Nome:</div>
                            <div class="detail-value" id="despachanteNome"></div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Contato:</div>
                            <div class="detail-value" id="despachanteContato"></div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Telefone:</div>
                            <div class="detail-value" id="despachanteTelefone"></div>
                        </div>
                    </div>
                </div>

                <!-- Product Details Section -->
                <div class="form-section">
                    <h2 class="section-title">Produtos do Pedido</h2>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Filial</th>
                                    <th>Caixas</th>
                                    <th>Descrição</th>
                                    <th>Item</th>
                                    <th>Nº Série</th>
                                    <th>Peso Bruto</th>
                                    <th>Peso Líq.</th>
                                    <th>Cód Produto</th>
                                    <th>Quantidade</th>
                                    <th>Volume m3</th>
                                    <th>Preço Unit. Venda</th>
                                    <th>Preço Unit. Compra</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody">
                                <!-- Products will be rendered here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tab Content: Documentos -->
            <div id="tabDocumentos" class="tab-content">
                <div class="form-section">
                    <h2 class="section-title">Documentos do Processo</h2>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Docs Fornece:</div>
                            <input type="text" id="docsFornecedor" readonly>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Serial Num.:</div>
                            <input type="text" id="serialNum" readonly>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Numero CI:</div>
                            <input type="text" id="numeroCI" readonly>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Numero BL:</div>
                            <input type="text" id="numeroBLDoc" readonly>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Cert.Origem:</div>
                            <input type="text" id="certOrigem" readonly>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Telex Releas:</div>
                            <input type="text" id="telexRelease" readonly>
                        </div>
                        <div class="detail-item span-all-columns">
                            <div class="detail-label">Remarks:</div>
                            <textarea id="remarksDoc" rows="3" readonly></textarea>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Env.Doc.Cont:</div>
                            <input type="date" id="emDocConf" readonly>
                        </div>
                    </div>
                    <div class="table-container" style="margin-top: 20px;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Documento</th>
                                    <th>Status</th>
                                    <th>Data Recebimento</th>
                                    <th>Ação</th>
                                </tr>
                            </thead>
                            <tbody id="documentsTableBody">
                                <!-- Documents will be rendered here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="form-section">
                    <h2 class="section-title">Arquivos Anexados</h2>
                    <ul id="attachedFilesList" class="attached-files-list">
                        <!-- Attached files will be rendered here -->
                    </ul>
                </div>
            </div>

            <!-- Tab Content: Financeiro -->
            <div id="tabFinanceiro" class="tab-content">
                <div class="form-section">
                    <h2 class="section-title">Informações Financeiras</h2>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Desconto:</div>
                            <input type="text" id="financeDesconto" readonly>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Tipo Descont:</div>
                            <input type="text" id="financeTipoDesconto" readonly>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Custo Extra:</div>
                            <input type="text" id="financeCustoExtra" readonly>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Tp Cust Extr:</div>
                            <input type="text" id="financeTpCustExtr" readonly>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">T/T Forneced:</div>
                            <input type="text" id="financeTitFornecedor" readonly>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Pgto Antecip:</div>
                            <input type="text" id="financePgtoAntecip" readonly>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Dt.Pg.Ant.CP:</div>
                            <input type="date" id="financeDtPgAntCP" readonly>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Pgto Sald CP:</div>
                            <input type="text" id="financePgtoSaldoCP" readonly>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Dt Pg Sal CP:</div>
                            <input type="date" id="financeDtPgSalCP" readonly>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">T/T Cliente:</div>
                            <input type="text" id="financeTitCliente" readonly>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Pg Antec CR:</div>
                            <input type="text" id="financePgAntecipCR" readonly>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Dt Pg Ant CR:</div>
                            <input type="date" id="financeDtPgAntCR" readonly>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Pg Saldo CR:</div>
                            <input type="text" id="financePgSaldoCR" readonly>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Dt Pg Sal CR:</div>
                            <input type="date" id="financeDtPgSalCR" readonly>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Mensagens (re-used from previous immersives) -->
    <div id="messageModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" id="messageModalCloseBtn">&times;</button>
            <h3 id="messageModalTitle"></h3>
            <div id="messageModalContent"></div>
            <div class="modal-actions">
                <button class="btn-primary" id="messageModalConfirmBtn">OK</button>
                <button class="btn-secondary" id="messageModalCancelBtn">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Visualização de Documentos de Texto -->
    <div id="documentViewerModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeDocumentViewerModal()">&times;</button>
            <h3 id="documentViewerTitle"></h3>
            <pre id="documentViewerContent" style="white-space: pre-wrap; word-wrap: break-word; max-height: 70vh; overflow-y: auto; background-color: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid var(--border-color);"></pre>
            <div class="modal-actions">
                <button class="btn-primary" onclick="closeDocumentViewerModal()">Fechar</button>
            </div>
        </div>
    </div>

    <!-- NOVO Modal para Visualização de PDF -->
    <div id="pdfViewerModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 90%; width: 90%; height: 90%; padding: 0;">
            <button class="modal-close-btn" onclick="closePdfViewerModal()">&times;</button>
            <h3 style="padding: 15px 30px; margin-bottom: 0;">Visualizador de PDF</h3>
            <iframe id="pdfFrame" style="width: 100%; height: calc(100% - 110px); border: none;"></iframe> <!-- Adjusted height for new button -->
            <div class="modal-actions" style="padding: 15px 30px; text-align: center;">
                <button class="btn-primary" onclick="sendPdfByEmail()">Enviar PDF</button>
                <button class="btn-secondary" onclick="closePdfViewerModal()">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Hidden container for PDF generation content -->
    <div id="pdfContentContainer">
        <div class="header-section">
            <div class="header-left">
                <!-- Updated image source to the requested URL with onerror fallback -->
                <img src="https://toyama.com.br/wp-content/uploads/2020/07/logo.png" alt="Toyama Hong Kong Ltd. Logo" onerror="this.onerror=null;this.src='https://placehold.co/150x50/cccccc/333333?text=LOGO';">
                <div class="company-info">
                    <strong>TOYAMA HONG KONG Ltd.</strong><br>
                    Suite 01-02A, 9/F, Tower 5, China Hong Kong City<br>
                    33 Canton Road, Tsim Sha Tsui, Kowloon, Hong Kong<br>
                    Tel: 852-2542 8343<br>
                    Fax: 852-2542 7002
                </div>
            </div>
            <div class="header-right">
                Customer Follow Up
            </div>
        </div>

        <div class="top-right-info">
            <div style="flex: 0.5;">
                <div class="label">Ready date:</div>
                <div class="value" id="pdfDocReadyDate"></div>
            </div>
            <div style="flex: 0.5;">
                <div class="label">Terms:</div>
                <div class="value" id="pdfDocTerms"></div>
            </div>
            <div style="flex: 0.5;">
                <div class="label">POL:</div>
                <div class="value" id="pdfDocPol"></div>
            </div>
        </div>
        <div class="highlight-box">
            Please always consider TYHK as "SHIPPER"
        </div>

        <div class="section-box">
            <div class="section-title">Consignee/Notify</div>
            <div class="section-content single-col">
                <div class="item-row full-width">
                    <span class="item-label">SHIP TO:</span>
                    <span class="item-value" id="pdfDocConsignee"></span>
                </div>
            </div>
        </div>

        <div class="section-box">
            <div class="section-title">Details</div>
            <div class="section-content three-cols">
                <div class="item-row">
                    <span class="item-label">Nr. PO-C:</span>
                    <span class="item-value" id="pdfDocPoC"></span>
                </div>
                <div class="item-row">
                    <span class="item-label">Nr. PI-C:</span>
                    <span class="item-value" id="pdfDocPiC"></span>
                </div>
                <div class="item-row">
                    <span class="item-label">POD:</span>
                    <span class="item-value" id="pdfDocPod"></span>
                </div>
            </div>
        </div>

        <div class="section-box">
            <div class="section-title">Follow Up</div>
            <div class="section-content single-col">
                <div class="item-row full-width">
                    <span class="item-value" id="pdfDocFollowUp"></span>
                </div>
            </div>
        </div>

        <div class="section-box">
            <div class="section-title">Financial</div>
            <div class="section-content three-cols">
                <div class="item-row">
                    <span class="item-label">T/T Amount:</span>
                    <span class="item-value" id="pdfDocTtAmount"></span>
                </div>
                <div class="item-row">
                    <span class="item-label">Down payment:</span>
                    <span class="item-value" id="pdfDocDownPayment"></span>
                </div>
                <div class="item-row">
                    <span class="item-label">Date:</span>
                    <span class="item-value" id="pdfDocDownPaymentDate"></span>
                </div>
                <div class="item-row">
                    <span class="item-label">Balance payment:</span>
                    <span class="item-value" id="pdfDocBalancePayment"></span>
                </div>
                <div class="item-row">
                    <span class="item-label">Date:</span>
                    <span class="item-value" id="pdfDocBalancePaymentDate"></span>
                </div>
            </div>
        </div>

        <div class="section-box">
            <div class="section-title">Docs and shipping details</div>
            <div class="section-content three-cols">
                <div class="item-row">
                    <span class="item-label">CI:</span>
                    <span class="item-value" id="pdfDocCi"></span>
                </div>
                <div class="item-row">
                    <span class="item-label">Container:</span>
                    <span class="item-value" id="pdfDocContainer"></span>
                </div>
                <div class="item-row">
                    <span class="item-label">Serial numbers:</span>
                    <span class="item-value" id="pdfDocSerialNumbers"></span>
                </div>
                <div class="item-row">
                    <span class="item-label">Forwarder:</span>
                    <span class="item-value" id="pdfDocForwarder"></span>
                </div>
                <div class="item-row">
                    <span class="item-label">Telex Release:</span>
                    <span class="item-value" id="pdfDocTelexRelease"></span>
                </div>
                <div class="item-row">
                    <span class="item-label">ETD:</span>
                    <span class="item-value" id="pdfDocEtd"></span>
                </div>
                <div class="item-row">
                    <span class="item-label">COO:</span>
                    <span class="item-value" id="pdfDocCoo"></span>
                </div>
                <div class="item-row">
                    <span class="item-label">ATD:</span>
                    <span class="item-value" id="pdfDocAtd"></span>
                </div>
                <div class="item-row">
                    <span class="item-label">BL:</span>
                    <span class="item-value" id="pdfDocBl"></span>
                </div>
                <div class="item-row">
                    <span class="item-label">ETA:</span>
                    <span class="item-value" id="pdfDocEta"></span>
                </div>
            </div>
        </div>

        <div class="section-box">
            <div class="section-title">Products</div>
            <table class="products-table">
                <thead>
                    <tr>
                        <th>P.N.</th>
                        <th>Description</th>
                        <th class="qty">Qty</th>
                        <th class="pkgs">Pkgs</th>
                        <th class="nw">N.W.</th>
                        <th class="gw">G.W.</th>
                        <th class="cbm">CBM</th>
                    </tr>
                </thead>
                <tbody id="pdfProductsTableBodyDoc">
                    <!-- Product rows will be inserted here by JavaScript -->
                </tbody>
            </table>
            <div style="font-size: 8pt; margin-top: 5px;">Puxar todas essas informações conforme estão no embarque!</div>
        </div>

        <div class="footer-text">
            Final data will be available at the documents, which will be sent with stamp and signature after sailing
        </div>
    </div>

    <script>
        console.log('Script loaded. Starting initialization...');
        let currentDimpexOrder = null; // Global variable to hold the currently viewed order

        // Simulated data for Dimpex orders (already approved by manager)
        // This data will be stored in localStorage
        const initialDimpexOrders = [
            {
                id: 'PED-015',
                poCliente: '1127TYCH',
                fornecedor: 'Fornecedor LONCIN',
                fornecedorLoja: '01',
                cliente: 'Cliente A',
                aprovacaoDate: '2025-06-29',
                statusDimpex: 'Reserva de Espaço (Booking)', // Starting point for Dimpex
                shipmentName: 'EMB-001-CLIA', // New field
                toyNumber: 'TOY1250001', // Example TOY number
                blNumber: 'BL-HKG-001', // Example BL
                blDate: '2025-07-10', // Example BL Date
                paymentDate: '2025-08-15', // Example Payment Date (Finance)
                pol: 'Shanghai', // Port of Loading
                pod: 'Santos', // Port of Discharge
                prevEmbarque: '2025-07-05', // Editable
                dtBooking: '2025-07-01',
                dtETA: '2025-08-18',
                dtDesembaraco: '', // Will be updated
                cargoAgent: 'Agente Marítimo X', // Editable
                paymentBeforeBL: true, // Finance field (read-only)
                container20: '1',
                container40: '0',
                container40HQ: '0',
                containerLCL: '0',
                followUp: 'Primeira reserva de espaço confirmada. Aguardando coleta da carga.',
                incoterm: 'FOB', // Editable
                customsBroker: { name: 'Despachante Alfa', contact: 'contato@alfa.com', phone: '11 9876-5432' },
                documents: [
                    { name: 'Solicitação do Cliente (PED-015)', status: 'Recebido', receivedDate: '2025-06-28', fileLink: '#',
                      content: '--- Solicitação do Cliente (PED-015) ---\n\nCliente: Cliente A\nData da Solicitação: 2025-06-28\n\nItens Solicitados:\n- Motor Diesel 10HP (Modelo MX-100): 5 unidades\n\nDetalhes Adicionais:\n- Uso: Novo projeto de expansão.\n- Prioridade: Alta.\n- Observações: Necessário entrega até 2025-08-20.\n\nAtenciosamente,\nEquipe de Compras Cliente A'
                    },
                    { name: 'PO Aprovada (PED-015)', status: 'Recebido', receivedDate: '2025-06-29', fileLink: '#',
                      content: '--- Ordem de Compra Aprovada (PO-1127TYCH) ---\n\nNúmero PO: 1127TYCH\nPedido Interno: PED-015\nFornecedor: Fornecedor LONCIN (Loja 01)\nData de Aprovação: 2025-06-29\n\nItens da PO:\n- Código: PROD001\n- Descrição: Motor Diesel 10HP (Modelo MX-100)\n- Quantidade: 5 UN\n- Preço Unitário (USD): 140.00\n- Preço Unitário (BRL): 152.00\n\nCondições de Pagamento: 30 dias após data BL.\nValor Total PO: USD 700.00\n\nStatus: APROVADA\n\nGerado por: Gerência de Compras'
                    },
                    { name: 'Bill of Lading (BL)', status: 'Pendente', receivedDate: '' },
                    { name: 'Commercial Invoice', status: 'Pendente', receivedDate: '' },
                    { name: 'Packing List', status: 'Pendente', receivedDate: '' },
                    { name: 'Certificado de Origem', status: 'Pendente', receivedDate: '' }
                ],
                productLines: [
                    {
                        branch: 'SP', // New field
                        boxes: 2, // New field
                        item: 1,
                        serialNumber: 'SN-MX100-001', // New field
                        grossWeight: 150.0, // New field
                        netWeight: 140.0, // New field
                        productCode: 'PROD001',
                        description: 'Motor Diesel 10HP',
                        quantity: 5,
                        volumeM3: 0.25, // New field
                        prcUnit: 152.00,
                        prcUnitFor: 140.00
                    }
                ],
                // Document specific fields
                docsFornecedor: 'INV-2025-001',
                serialNum: 'SN-001-XYZ',
                numeroCI: 'CI-98765',
                numeroBLDoc: 'BL-HKG-001',
                certOrigem: 'CO-ABC-123',
                remarksDoc: 'Documentos iniciais recebidos e conferidos. Aguardando BL original.',
                emDocConf: '2025-07-01',
                telexRelease: 'Sim', // New field
                // Finance specific fields
                desconto: '100.00',
                tipoDesconto: 'Volume',
                custoExtra: '50.00', // Renamed from custoEntrega
                tpQualEntrega: 'Normal', // Renamed from tpQualEntrega
                titFornecedor: '23600.00',
                pgtoAntecip: '7098.00',
                dtPgAntCP: '2025-06-20',
                pgtoSaldoCP: '16502.00',
                dtPgSalCP: '2025-08-10',
                titCliente: '30256.00',
                pgAntecipCR: '9061.00',
                dtPgAntCR: '2025-07-01',
                pgSaldoCR: '20000.00',
                dtPgSalCR: '2025-09-01',
                dtFinalizado: '2025-08-25' // New field
            },
            {
                id: 'PED-019',
                poCliente: '8795MX',
                fornecedor: 'Fornecedor XY',
                fornecedorLoja: '02',
                cliente: 'Cliente B',
                aprovacaoDate: '2025-06-30',
                statusDimpex: 'Reserva de Espaço (Booking)',
                shipmentName: 'EMB-002-CLIB',
                toyNumber: 'TOY1250002',
                blNumber: '',
                blDate: '',
                paymentDate: '2025-09-01',
                pol: 'Guangzhou',
                pod: 'Paranaguá',
                prevEmbarque: '2025-07-08',
                dtBooking: '2025-07-03',
                dtETA: '2025-09-05',
                dtDesembaraco: '',
                cargoAgent: 'Logística Global',
                paymentBeforeBL: false,
                container20: '0',
                container40: '1',
                container40HQ: '0',
                containerLCL: '0',
                followUp: 'Coleta agendada para amanhã. Documentos iniciais recebidos.',
                incoterm: 'CIF',
                customsBroker: { name: 'Despachante Beta', contact: 'contato@beta.com', phone: '21 9987-6543' },
                documents: [
                    { name: 'Solicitação do Cliente (PED-019)', status: 'Recebido', receivedDate: '2025-06-29', fileLink: '#' },
                    { name: 'PO Aprovada (PED-019)', status: 'Recebido', receivedDate: '2025-06-30', fileLink: '#' },
                    { name: 'Bill of Lading (BL)', status: 'Pendente', receivedDate: '' },
                    { name: 'Commercial Invoice', status: 'Pendente', receivedDate: '' },
                    { name: 'Packing List', status: 'Pendente', receivedDate: '' },
                    { name: 'Licença de Importação', status: 'Pendente', receivedDate: '' }
                ],
                productLines: [
                    {
                        branch: 'RJ',
                        boxes: 1,
                        item: 1,
                        serialNumber: 'SN-GEN5000-001',
                        grossWeight: 200.0,
                        netWeight: 180.0,
                        productCode: 'PROD002',
                        description: 'Gerador a Gasolina 5kVA',
                        quantity: 1,
                        volumeM3: 0.8,
                        prcUnit: 310.00,
                        prcUnitFor: 280.00
                    }
                ],
                docsFornecedor: 'INV-2025-002',
                serialNum: 'SN-002-ABC',
                numeroCI: 'CI-12345',
                numeroBLDoc: '',
                certOrigem: 'CO-DEF-456',
                remarksDoc: 'Aguardando coleta e emissão de BL.',
                emDocConf: '2025-07-02',
                telexRelease: 'Não',
                desconto: '50.00',
                tipoDesconto: 'Promocional',
                custoExtra: '75.00',
                tpQualEntrega: 'Expresso',
                titFornecedor: '15000.00',
                pgtoAntecip: '3000.00',
                dtPgAntCP: '2025-06-25',
                pgtoSaldoCP: '12000.00',
                dtPgSalCP: '2025-08-20',
                titCliente: '18000.00',
                pgAntecipCR: '5000.00',
                dtPgAntCR: '2025-06-30',
                pgSaldoCR: '13000.00',
                dtPgSalCR: '2025-09-15',
                dtFinalizado: ''
            },
            {
                id: 'PED-020',
                poCliente: '0129VO',
                fornecedor: 'Fornecedor LONCIN',
                fornecedorLoja: '01',
                cliente: 'Toyama Chile',
                aprovacaoDate: '2025-06-25',
                statusDimpex: 'Saída do Porto de Embarque (ATD)',
                shipmentName: 'EMB-003-TYCH',
                toyNumber: 'TOY1250003',
                blNumber: 'BL-HKG-002',
                blDate: '2025-07-05',
                paymentDate: '2025-08-25',
                pol: 'Ningbo',
                pod: 'Valparaíso',
                prevEmbarque: '2025-07-03',
                dtBooking: '2025-06-28',
                dtETA: '2025-08-20',
                dtDesembaraco: '',
                cargoAgent: 'TransOceanic',
                paymentBeforeBL: true,
                container20: '0',
                container40: '0',
                container40HQ: '0',
                containerLCL: '1',
                followUp: 'Carga embarcada com sucesso. BL e documentos principais recebidos.',
                incoterm: 'EXW',
                customsBroker: { name: 'Despachante Gama', contact: 'contato@gama.com', phone: '51 9765-4321' },
                documents: [
                    { name: 'Solicitação do Cliente (PED-020)', status: 'Recebido', receivedDate: '2025-06-24', fileLink: '#' },
                    { name: 'PO Aprovada (PED-020)', status: 'Recebido', receivedDate: '2025-06-25', fileLink: '#' },
                    { name: 'Bill of Lading (BL)', status: 'Recebido', receivedDate: '2025-07-01' },
                    { name: 'Commercial Invoice', status: 'Recebido', receivedDate: '2025-07-01' },
                    { name: 'Packing List', status: 'Recebido', receivedDate: '2025-07-01' }
                ],
                productLines: [
                    {
                        branch: 'MG',
                        boxes: 5,
                        item: 1,
                        serialNumber: 'SN-MINIPUMP-001',
                        grossWeight: 15.0,
                        netWeight: 12.0,
                        productCode: 'PROD003',
                        description: 'Mini Bomba D\'água',
                        quantity: 15,
                        volumeM3: 0.1,
                        prcUnit: 22.00,
                        prcUnitFor: 20.00
                    }
                ],
                docsFornecedor: 'INV-2025-003',
                serialNum: 'SN-003-DEF',
                numeroCI: 'CI-67890',
                numeroBLDoc: 'BL-HKG-002',
                certOrigem: 'CO-GHI-789',
                remarksDoc: 'Todos os documentos de embarque recebidos.',
                emDocConf: '2025-07-05',
                telexRelease: 'Sim',
                desconto: '20.00',
                tipoDesconto: 'Quantidade',
                custoExtra: '30.00',
                tpQualEntrega: 'Padrão',
                titFornecedor: '5000.00',
                pgtoAntecip: '1000.00',
                dtPgAntCP: '2025-06-20',
                pgtoSaldoCP: '4000.00',
                dtPgSalCP: '2025-08-01',
                titCliente: '6000.00',
                pgAntecipCR: '2000.00',
                dtPgAntCR: '2025-06-25',
                pgSaldoCR: '4000.00',
                dtPgSalCR: '2025-08-15',
                dtFinalizado: ''
            },
            {
                id: 'PED-025',
                poCliente: '4040JKL',
                fornecedor: 'Fornecedor XY',
                fornecedorLoja: '02',
                cliente: 'Cliente G',
                aprovacaoDate: '2025-07-05',
                statusDimpex: 'Em Trânsito',
                shipmentName: 'EMB-004-CLIG',
                toyNumber: 'TOY1250004',
                blNumber: 'BL-HKG-003',
                blDate: '2025-07-12',
                paymentDate: '2025-09-20',
                pol: 'Shanghai',
                pod: 'Manaus',
                prevEmbarque: '2025-07-10',
                dtBooking: '2025-07-08',
                dtETA: '2025-10-20',
                dtDesembaraco: '',
                cargoAgent: 'Ocean Freight',
                paymentBeforeBL: false,
                container20: '0',
                container40: '1',
                container40HQ: '0',
                containerLCL: '0',
                followUp: 'Navio a caminho. Monitorando a ETA.',
                incoterm: 'FOB',
                customsBroker: { name: 'Despachante Theta', contact: 'contato@theta.com', phone: '91 9456-7890' },
                documents: [
                    { name: 'Solicitação do Cliente (PED-025)', status: 'Recebido', receivedDate: '2025-07-04', fileLink: '#' },
                    { name: 'PO Aprovada (PED-025)', status: 'Recebido', receivedDate: '2025-07-05', fileLink: '#' },
                    { name: 'Bill of Lading (BL)', status: 'Recebido', receivedDate: '2025-07-12' },
                    { name: 'Commercial Invoice', status: 'Recebido', receivedDate: '2025-07-12' },
                    { name: 'Packing List', status: 'Recebido', receivedDate: '2025-07-12' }
                ],
                productLines: [
                    {
                        branch: 'SP',
                        boxes: 1,
                        item: 1,
                        serialNumber: 'SN-GEN5000-002',
                        grossWeight: 200.0,
                        netWeight: 180.0,
                        productCode: 'PROD002',
                        description: 'Gerador a Gasolina 5kVA',
                        quantity: 2,
                        volumeM3: 0.8,
                        prcUnit: 2500.00,
                        prcUnitFor: 1200.00
                    }
                ],
                docsFornecedor: 'INV-2025-004',
                serialNum: 'SN-004-GHI',
                numeroCI: 'CI-11223',
                numeroBLDoc: 'BL-HKG-003',
                certOrigem: 'CO-JKL-012',
                remarksDoc: 'Em trânsito. Acompanhando a localização do navio.',
                emDocConf: '2025-07-12',
                telexRelease: 'Não',
                desconto: '0.00',
                tipoDesconto: 'Nenhum',
                custoExtra: '100.00',
                tpQualEntrega: 'Normal',
                titFornecedor: '24000.00',
                pgtoAntecip: '0.00',
                dtPgAntCP: '',
                pgtoSaldoCP: '24000.00',
                dtPgSalCP: '2025-09-10',
                titCliente: '30000.00',
                pgAntecipCR: '0.00',
                dtPgAntCR: '',
                pgSaldoCR: '30000.00',
                dtPgSalCR: '2025-10-05',
                dtFinalizado: ''
            },
            {
                id: 'PED-026',
                poCliente: '5050MNO',
                fornecedor: 'Fornecedor LONCIN',
                fornecedorLoja: '01',
                cliente: 'Cliente H',
                aprovacaoDate: '2025-07-06',
                statusDimpex: 'Chegada no Porto de Destino (ATA)',
                shipmentName: 'EMB-005-CLIh',
                toyNumber: 'TOY1250005',
                blNumber: 'BL-HKG-004',
                blDate: '2025-07-15',
                paymentDate: '2025-10-01',
                pol: 'Ningbo',
                pod: 'Salvador',
                prevEmbarque: '2025-07-13',
                dtBooking: '2025-07-10',
                dtETA: '2025-10-25',
                dtDesembaraco: '',
                cargoAgent: 'Sea Cargo',
                paymentBeforeBL: true,
                container20: '0',
                container40: '0',
                container40HQ: '0',
                containerLCL: '1',
                followUp: 'Carga chegou ao porto. Aguardando início do desembaraço.',
                incoterm: 'CFR',
                customsBroker: { name: 'Despachante Iota', contact: 'contato@iota.com', phone: '71 9678-9012' },
                documents: [
                    { name: 'Solicitação do Cliente (PED-026)', status: 'Recebido', receivedDate: '2025-07-05', fileLink: '#' },
                    { name: 'PO Aprovada (PED-026)', status: 'Recebido', receivedDate: '2025-07-06', fileLink: '#' },
                    { name: 'Bill of Lading (BL)', status: 'Recebido', receivedDate: '2025-07-15' },
                    { name: 'Commercial Invoice', status: 'Recebido', receivedDate: '2025-07-15' },
                    { name: 'Packing List', status: 'Recebido', receivedDate: '2025-07-15' }
                ],
                productLines: [
                    {
                        branch: 'BA',
                        boxes: 3,
                        item: 1,
                        serialNumber: 'SN-MINIPUMP-002',
                        grossWeight: 10.0,
                        netWeight: 8.0,
                        productCode: 'PROD003',
                        description: 'Mini Bomba D\'água',
                        quantity: 10,
                        volumeM3: 0.08,
                        prcUnit: 250.00,
                        prcUnitFor: 120.00
                    }
                ],
                docsFornecedor: 'INV-2025-005',
                serialNum: 'SN-005-MNO',
                numeroCI: 'CI-44556',
                numeroBLDoc: 'BL-HKG-004',
                certOrigem: 'CO-PQR-345',
                remarksDoc: 'Carga no porto de destino. Preparando documentação para alfândega.',
                emDocConf: '2025-07-15',
                telexRelease: 'Sim',
                desconto: '15.00',
                tipoDesconto: 'Fidelidade',
                custoExtra: '20.00',
                tpQualEntrega: 'Padrão',
                titFornecedor: '12000.00',
                pgtoAntecip: '2500.00',
                dtPgAntCP: '2025-07-01',
                pgtoSaldoCP: '9500.00',
                dtPgSalCP: '2025-09-20',
                titCliente: '14000.00',
                pgAntecipCR: '4000.00',
                dtPgAntCR: '2025-07-06',
                pgSaldoCR: '10000.00',
                dtPgSalCR: '2025-10-10',
                dtFinalizado: ''
            },
            {
                id: 'PED-027',
                poCliente: '6060PQR',
                fornecedor: 'Fornecedor XY',
                fornecedorLoja: '02',
                cliente: 'Cliente I',
                aprovacaoDate: '2025-07-07',
                statusDimpex: 'Chegada no Porto de Destino (ATA)',
                shipmentName: 'EMB-006-CLII',
                toyNumber: 'TOY1250006',
                blNumber: 'BL-HKG-005',
                blDate: '2025-07-18',
                paymentDate: '2025-10-05',
                pol: 'Guangzhou',
                pod: 'Fortaleza',
                prevEmbarque: '2025-07-16',
                dtBooking: '2025-07-14',
                dtETA: '2025-11-01',
                dtDesembaraco: '2025-07-25',
                cargoAgent: 'Porto Forte',
                paymentBeforeBL: false,
                container20: '1',
                container40: '0',
                container40HQ: '0',
                containerLCL: '0',
                followUp: 'Documentos entregues ao despachante. Desembaraço em andamento.',
                incoterm: 'DAP',
                customsBroker: { name: 'Despachante Kappa', contact: 'contato@kappa.com', phone: '85 9123-4567' },
                documents: [
                    { name: 'Solicitação do Cliente (PED-027)', status: 'Recebido', receivedDate: '2025-07-06', fileLink: '#' },
                    { name: 'PO Aprovada (PED-027)', status: 'Recebido', receivedDate: '2025-07-07', fileLink: '#' },
                    { name: 'Bill of Lading (BL)', status: 'Recebido', receivedDate: '2025-07-18' },
                    { name: 'Commercial Invoice', status: 'Recebido', receivedDate: '2025-07-18' },
                    { name: 'Packing List', status: 'Recebido', receivedDate: '2025-07-18' },
                    { name: 'Certificado de Conformidade', status: 'Pendente', receivedDate: '' }
                ],
                productLines: [
                    {
                        branch: 'CE',
                        boxes: 1,
                        item: 1,
                        serialNumber: 'SN-MX100-003',
                        grossWeight: 150.0,
                        netWeight: 140.0,
                        productCode: 'PROD001',
                        description: 'Motor Diesel 10HP',
                        quantity: 3,
                        volumeM3: 0.25,
                        prcUnit: 1500.00,
                        prcUnitFor: 800.00
                    }
                ],
                docsFornecedor: 'INV-2025-006',
                serialNum: 'SN-006-STU',
                numeroCI: 'CI-77889',
                numeroBLDoc: 'BL-HKG-005',
                certOrigem: 'CO-VWX-678',
                remarksDoc: 'Desembaraço aduaneiro em fase final. Aguardando liberação.',
                emDocConf: '2025-07-20',
                telexRelease: 'Não',
                desconto: '0.00',
                tipoDesconto: 'Nenhum',
                custoExtra: '40.00',
                tpQualEntrega: 'Padrão',
                titFornecedor: '24000.00',
                pgtoAntecip: '00.00',
                dtPgAntCP: '',
                pgtoSaldoCP: '24000.00',
                dtPgSalCP: '2025-09-25',
                titCliente: '28000.00',
                pgAntecipCR: '0.00',
                dtPgAntCR: '',
                pgSaldoCR: '28000.00',
                dtPgSalCR: '2025-10-20',
                dtFinalizado: ''
            },
            {
                id: 'PED-028',
                poCliente: '7070STU',
                fornecedor: 'Fornecedor LONCIN',
                fornecedorLoja: '01',
                cliente: 'Cliente J',
                aprovacaoDate: '2025-07-08',
                statusDimpex: 'Chegada no Porto de Destino (ATA)',
                shipmentName: 'EMB-007-CLIJ',
                toyNumber: 'TOY1250007',
                blNumber: 'BL-HKG-006',
                blDate: '2025-07-20',
                paymentDate: '2025-10-10',
                pol: 'Foshan',
                pod: 'Goiânia',
                prevEmbarque: '2025-07-18',
                dtBooking: '2025-07-16',
                dtETA: '2025-11-05',
                dtDesembaraco: '2025-07-28',
                cargoAgent: 'Carga Rápida',
                paymentBeforeBL: true,
                container20: '0',
                container40: '1',
                container40HQ: '0',
                containerLCL: '0',
                followUp: 'Carga liberada pela alfândega. Aguardando agendamento de transporte final.',
                incoterm: 'DDP',
                customsBroker: { name: 'Despachante Lambda', contact: 'contato@lambda.com', phone: '62 9876-5432' },
                documents: [
                    { name: 'Solicitação do Cliente (PED-028)', status: 'Recebido', receivedDate: '2025-07-07', fileLink: '#' },
                    { name: 'PO Aprovada (PED-028)', status: 'Recebido', receivedDate: '2025-07-08', fileLink: '#' },
                    { name: 'Bill of Lading (BL)', status: 'Recebido', receivedDate: '2025-07-20' },
                    { name: 'Commercial Invoice', status: 'Recebido', receivedDate: '2025-07-20' },
                    { name: 'Packing List', status: 'Recebido', receivedDate: '2025-07-20' },
                    { name: 'Comprovante de Pagamento de Impostos', status: 'Recebido', receivedDate: '2025-07-20' }
                ],
                productLines: [
                    {
                        branch: 'GO',
                        boxes: 1,
                        item: 1,
                        serialNumber: 'SN-GEN5000-004',
                        grossWeight: 200.0,
                        netWeight: 180.0,
                        productCode: 'PROD002',
                        description: 'Gerador a Gasolina 5kVA',
                        quantity: 1,
                        volumeM3: 0.8,
                        prcUnit: 2500.00,
                        prcUnitFor: 1200.00
                    }
                ],
                docsFornecedor: 'INV-2025-007',
                serialNum: 'SN-007-ABC',
                numeroCI: 'CI-99887',
                numeroBLDoc: 'BL-HKG-006',
                certOrigem: 'CO-DEF-901',
                remarksDoc: 'Carga liberada. Coordenando transporte terrestre.',
                emDocConf: '2025-07-28',
                telexRelease: 'Sim',
                desconto: '0.00',
                tipoDesconto: 'Nenhum',
                custoExtra: '60.00',
                tpQualEntrega: 'Expresso',
                titFornecedor: '12000.00',
                pgtoAntecip: '0.00',
                dtPgAntCP: '',
                pgtoSaldoCP: '12000.00',
                dtPgSalCP: '2025-10-01',
                titCliente: '15000.00',
                pgAntecipCR: '0.00',
                dtPgAntCR: '',
                pgSaldoCR: '15000.00',
                dtPgSalCR: '2025-11-01',
                dtFinalizado: ''
            },
            {
                id: 'PED-029',
                poCliente: '8080VWX',
                fornecedor: 'Fornecedor XY',
                fornecedorLoja: '02',
                cliente: 'Cliente K',
                aprovacaoDate: '2025-07-09',
                statusDimpex: 'Entrega ao Cliente',
                shipmentName: 'EMB-008-CLIK',
                toyNumber: 'TOY1250008',
                blNumber: 'BL-HKG-007',
                blDate: '2025-07-22',
                paymentDate: '2025-10-15',
                pol: 'Shenzhen',
                pod: 'São Paulo',
                prevEmbarque: '2025-07-20',
                dtBooking: '2025-07-18',
                dtETA: '2025-11-10',
                dtDesembaraco: '2025-07-30',
                cargoAgent: 'Transportadora Expressa',
                paymentBeforeBL: true,
                container20: '0',
                container40: '0',
                container40HQ: '0',
                containerLCL: '1',
                followUp: 'Carga entregue com sucesso ao cliente. Processo finalizado.',
                incoterm: 'FOB',
                customsBroker: { name: 'Despachante Mu', contact: 'contato@mu.com', phone: '11 9111-2222' },
                documents: [
                    { name: 'Solicitação do Cliente (PED-029)', status: 'Recebido', receivedDate: '2025-07-08', fileLink: '#' },
                    { name: 'PO Aprovada (PED-029)', status: 'Recebido', receivedDate: '2025-07-09', fileLink: '#' },
                    { name: 'Bill of Lading (BL)', status: 'Recebido', receivedDate: '2025-07-22' },
                    { name: 'Commercial Invoice', status: 'Recebido', receivedDate: '2025-07-22' },
                    { name: 'Packing List', status: 'Recebido', receivedDate: '2025-07-22' },
                    { name: 'Comprovante de Entrega', status: 'Recebido', receivedDate: '2025-07-22' }
                ],
                productLines: [
                    {
                        branch: 'SP',
                        boxes: 2,
                        item: 1,
                        serialNumber: 'SN-MINIPUMP-003',
                        grossWeight: 15.0,
                        netWeight: 12.0,
                        productCode: 'PROD003',
                        description: 'Mini Bomba D\'água',
                        quantity: 5,
                        volumeM3: 0.1,
                        prcUnit: 250.00,
                        prcUnitFor: 120.00
                    }
                ],
                docsFornecedor: 'INV-2025-008',
                serialNum: 'SN-008-CDE',
                numeroCI: 'CI-11334',
                numeroBLDoc: 'BL-HKG-007',
                certOrigem: 'CO-FGH-234',
                remarksDoc: 'Entrega finalizada. Processo concluído.',
                emDocConf: '2025-07-30',
                telexRelease: 'Sim',
                desconto: '25.00',
                tipoDesconto: 'Liquidação',
                custoExtra: '15.00',
                tpQualEntrega: 'Padrão',
                titFornecedor: '6000.00',
                pgtoAntecip: '1500.00',
                dtPgAntCP: '2025-07-05',
                pgtoSaldoCP: '4500.00',
                dtPgSalCP: '2025-10-01',
                titCliente: '7500.00',
                pgAntecipCR: '2000.00',
                dtPgAntCR: '2025-07-10',
                pgSaldoCR: '5500.00',
                dtPgSalCR: '2025-11-05',
                dtFinalizado: '2025-07-31'
            }
        ];

        let dimpexOrders = [];

        const dimpexTrackingFlow = [
            { name: 'Aprovado', class: 'approved', description: 'Pedido aprovado pela Gerência, aguardando início do processo Dimpex.' },
            { name: 'Em Produção', class: 'in-production', description: 'Fornecedor iniciou a produção dos itens.' },
            { name: 'Carga Pronta', class: 'ready-cargo', description: 'Mercadoria pronta para embarque na origem.' },
            { name: 'Reserva de Espaço (Booking)', class: 'booking', description: 'Espaço no navio reservado.' },
            { name: 'Saída do Porto de Embarque (ATD)', class: 'atd', description: 'Carga embarcada e saiu do porto de origem.' },
            { name: 'Documentação Pendente', class: 'pending-doc', description: 'Aguardando recebimento e conferência de documentos do despachante.' },
            { name: 'Documentação OK', class: 'doc-ok', description: 'Todos os documentos recebidos e validados.' },
            { name: 'Em Trânsito', class: 'in-transit', description: 'Navio com a carga está em trânsito.' },
            { name: 'Chegada no Porto de Destino (ATA)', class: 'ata', description: 'Navio chegou ao porto de destino.' },
            { name: 'Entrega ao Cliente', class: 'delivered', description: 'Mercadoria entregue ao cliente.' }
        ];

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const [year, month, day] = dateString.split('-');
            if (year && month && day) {
                return `${day}/${month}/${year}`;
            }
            return dateString;
        }

        function showMessage(title, content, type = 'info', onConfirm = null, onCancel = null) {
            console.log(`Showing message: ${title} - ${content}`);
            const modal = document.getElementById('messageModal');
            const modalTitle = document.getElementById('messageModalTitle');
            const modalContent = document.getElementById('messageModalContent');
            const confirmBtn = document.getElementById('messageModalConfirmBtn');
            const cancelBtn = document.getElementById('messageModalCancelBtn');
            const closeBtn = document.getElementById('messageModalCloseBtn');

            if (!modal || !modalTitle || !modalContent || !confirmBtn || !cancelBtn || !closeBtn) {
                console.error('One or more modal elements not found.');
                return;
            }

            modalTitle.innerText = title;
            modalContent.innerHTML = content;

            confirmBtn.onclick = () => { if (onConfirm) onConfirm(); modal.classList.remove('active'); };
            cancelBtn.onclick = () => { if (onCancel) onCancel(); modal.classList.remove('active'); };
            closeBtn.onclick = () => modal.classList.remove('active');

            confirmBtn.classList.add('hidden');
            cancelBtn.classList.add('hidden');
            closeBtn.classList.remove('hidden');

            if (onConfirm || onCancel) {
                closeBtn.classList.add('hidden');
                confirmBtn.classList.remove('hidden');
                if (onCancel) {
                    cancelBtn.classList.remove('hidden');
                }
            }
            modal.classList.add('active');
            console.log('Message modal displayed.');
        }

        function showCentralPage() {
            console.log('Showing central page...');
            const detailPage = document.getElementById('dimpex-detail-page');
            const centralPage = document.getElementById('dimpex-central-page');
            if (detailPage) detailPage.classList.remove('active');
            if (centralPage) centralPage.classList.add('active');
            renderDashboardKPIs();
            renderDimpexOrdersTable();
            console.log('Central page shown.');
        }

        function showDetailPage(orderId) {
            console.log(`Showing detail page for order ID: ${orderId}`);
            const order = dimpexOrders.find(o => o.id === orderId);
            if (order) {
                currentDimpexOrder = order;
                const centralPage = document.getElementById('dimpex-central-page');
                const detailPage = document.getElementById('dimpex-detail-page');
                if (centralPage) centralPage.classList.remove('active');
                if (detailPage) detailPage.classList.add('active');
                renderDimpexOrderDetails();
                openTab(null, 'tabGeral');
                console.log('Detail page shown.');
            } else {
                showMessage('Erro', 'Embarque não encontrado.', 'error');
            }
        }

        function renderDimpexOrdersTable() {
            console.log('Rendering Dimpex orders table...');
            const tbody = document.getElementById('dimpexOrdersTableBody');
            if (!tbody) {
                console.error('dimpexOrdersTableBody not found.');
                return;
            }
            tbody.innerHTML = '';

            const statusFilterElement = document.getElementById('statusFilter');
            const statusFilter = statusFilterElement ? statusFilterElement.value : 'Todos';

            let filteredOrders = dimpexOrders.filter(order => {
                return statusFilter === 'Todos' || order.statusDimpex === statusFilter;
            });

            if (filteredOrders.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 20px;">Nenhum embarque encontrado para o status selecionado.</td></tr>`;
                return;
            }

            filteredOrders.forEach(order => {
                const row = document.createElement('tr');
                row.onclick = () => showDetailPage(order.id);

                let statusClass = '';
                const flowStep = dimpexTrackingFlow.find(step => step.name === order.statusDimpex);
                if (flowStep) {
                    statusClass = flowStep.class;
                }
                
                row.innerHTML = `
                    <td>${formatDate(order.aprovacaoDate)}</td>
                    <td>${order.shipmentName || 'N/A'}</td>
                    <td>${order.fornecedor || 'N/A'}</td>
                    <td>${order.blNumber || 'N/A'}</td>
                    <td>${formatDate(order.blDate)}</td>
                    <td>${order.fornecedorLoja || 'N/A'}</td>
                    <td>${order.paymentBeforeBL ? 'Sim' : 'Não'}</td>
                    <td><span class="status-indicator ${statusClass}"></span>${order.statusDimpex}</td>
                `;
                tbody.appendChild(row);
            });
            console.log('Dimpex orders table rendered.');
        }

        const safeGetValue = (id) => {
            const element = document.getElementById(id);
            return element ? element.value : '';
        };

        function renderDimpexOrderDetails() {
            console.log('Rendering Dimpex order details...');
            if (!currentDimpexOrder) {
                showMessage('Erro', 'Nenhum embarque selecionado. Retornando à Central Dimpex.', 'error', () => {
                    showCentralPage();
                });
                return;
            }

            const safeSetValue = (id, value) => {
                const element = document.getElementById(id);
                if (element) {
                    element.value = value !== undefined && value !== null ? value : '';
                } else {
                    console.warn(`Element with ID '${id}' not found. Cannot set its value.`);
                }
            };

            const safeSetText = (id, text) => {
                const element = document.getElementById(id);
                if (element) {
                    element.innerText = text !== undefined && text !== null ? text : 'N/A';
                } else {
                    console.warn(`Element with ID '${id}' not found. Cannot set its text.`);
                }
            };

            safeSetText('detailShipmentName', currentDimpexOrder.shipmentName);
            safeSetText('overviewOrderId', currentDimpexOrder.id);
            safeSetValue('detailShipmentNameInput', currentDimpexOrder.shipmentName);
            safeSetValue('detailShipmentDate', currentDimpexOrder.aprovacaoDate);
            safeSetValue('detailFornecedor', currentDimpexOrder.fornecedor);
            safeSetValue('detailFornecedorLoja', currentDimpexOrder.fornecedorLoja);
            safeSetValue('detailToyNumber', currentDimpexOrder.toyNumber);
            safeSetValue('detailIncoterm', currentDimpexOrder.incoterm);
            safeSetValue('detailPol', currentDimpexOrder.pol);
            safeSetValue('detailPod', currentDimpexOrder.pod);
            safeSetValue('detailPrevEmbarque', currentDimpexOrder.prevEmbarque);
            safeSetValue('detailPagtoAntBL', currentDimpexOrder.paymentBeforeBL ? 'Sim' : 'Não');
            safeSetValue('detailCargoAgent', currentDimpexOrder.cargoAgent);
            safeSetValue('detailDtBooking', currentDimpexOrder.dtBooking);
            safeSetValue('detailBlNumber', currentDimpexOrder.blNumber);
            safeSetValue('detailBlDate', currentDimpexOrder.blDate);
            safeSetValue('detailDtETA', currentDimpexOrder.dtETA);
            safeSetValue('detailDtDesembaraco', currentDimpexOrder.dtDesembaraco);
            safeSetValue('detailDtFinalizado', currentDimpexOrder.dtFinalizado);

            safeSetValue('detailCont20', String(currentDimpexOrder.container20 || ''));
            safeSetValue('detailCont40', String(currentDimpexOrder.container40 || ''));
            safeSetValue('detailCont40HQ', String(currentDimpexOrder.container40HQ || ''));
            safeSetValue('detailContLCL', String(currentDimpexOrder.containerLCL || ''));

            safeSetValue('detailFollowUp', currentDimpexOrder.followUp);

            renderTracking(currentDimpexOrder.statusDimpex);
            safeSetValue('newStatusSelect', currentDimpexOrder.statusDimpex);

            if (currentDimpexOrder.customsBroker) {
                safeSetText('despachanteNome', currentDimpexOrder.customsBroker.name);
                safeSetText('despachanteContato', currentDimpexOrder.customsBroker.contact);
                safeSetText('despachanteTelefone', currentDimpexOrder.customsBroker.phone);
            } else {
                safeSetText('despachanteNome', 'N/A');
                safeSetText('despachanteContato', 'N/A');
                safeSetText('despachanteTelefone', 'N/A');
            }

            renderProductsTable();

            safeSetValue('docsFornecedor', currentDimpexOrder.docsFornecedor);
            safeSetValue('serialNum', currentDimpexOrder.serialNum);
            safeSetValue('numeroCI', currentDimpexOrder.numeroCI);
            safeSetValue('numeroBLDoc', currentDimpexOrder.numeroBLDoc);
            safeSetValue('certOrigem', currentDimpexOrder.certOrigem);
            safeSetValue('remarksDoc', currentDimpexOrder.remarksDoc);
            safeSetValue('emDocConf', currentDimpexOrder.emDocConf);
            safeSetValue('telexRelease', currentDimpexOrder.telexRelease);
            renderDocumentsTable();
            renderAttachedFiles();

            safeSetValue('financeDesconto', currentDimpexOrder.desconto);
            safeSetValue('financeTipoDesconto', currentDimpexOrder.tipoDesconto);
            safeSetValue('financeCustoExtra', currentDimpexOrder.custoExtra);
            safeSetValue('financeTpCustExtr', currentDimpexOrder.tpQualEntrega);
            safeSetValue('financeTitFornecedor', currentDimpexOrder.titFornecedor);
            safeSetValue('financePgtoAntecip', currentDimpexOrder.pgtoAntecip);
            safeSetValue('financeDtPgAntCP', currentDimpexOrder.dtPgAntCP);
            safeSetValue('financePgtoSaldoCP', currentDimpexOrder.pgtoSaldoCP);
            safeSetValue('financeDtPgSalCP', currentDimpexOrder.dtPgSalCP);
            safeSetValue('financeTitCliente', currentDimpexOrder.titCliente);
            safeSetValue('financePgAntecipCR', currentDimpexOrder.pgAntecipCR);
            safeSetValue('financeDtPgAntCR', currentDimpexOrder.dtPgAntCR);
            safeSetValue('financePgSaldoCR', currentDimpexOrder.pgSaldoCR);
            safeSetValue('financeDtPgSalCR', currentDimpexOrder.dtPgSalCR);
            console.log('Dimpex order details rendered.');
        }

        function renderTracking(currentStatus) {
            console.log(`Rendering tracking for status: ${currentStatus}`);
            const trackingSection = document.getElementById('dimpexTrackingSection');
            if (!trackingSection) {
                console.error('dimpexTrackingSection not found.');
                return;
            }
            trackingSection.innerHTML = '';

            let currentStatusIndex = dimpexTrackingFlow.findIndex(step => step.name === currentStatus);

            let trackingHtml = '<div class="tracking-steps">';

            dimpexTrackingFlow.forEach((step, index) => {
                let stepClass = '';
                let circleContent = '';

                if (index < currentStatusIndex) {
                    stepClass = 'completed';
                } else if (index === currentStatusIndex) {
                    stepClass = 'active';
                } else {
                    stepClass = 'future';
                }
                
                if (step.class) {
                    stepClass += ` ${step.class}`;
                }

                if (stepClass.includes('completed')) {
                    circleContent = '&#10003;';
                } else if (stepClass.includes('active')) {
                    circleContent = (index + 1).toString();
                }

                trackingHtml += `
                    <div class="tracking-step ${stepClass}">
                        <div class="circle">${circleContent}</div>
                        <span>${step.name}</span>
                    </div>
                `;
            });
            trackingHtml += '</div>';
            trackingSection.innerHTML = trackingHtml;
            console.log('Tracking rendered.');
        }

        function saveOrderStatus() {
            console.log('Saving order status...');
            if (!currentDimpexOrder) {
                showMessage('Erro', 'Nenhum embarque carregado.', 'error');
                return;
            }

            const newStatusSelect = document.getElementById('newStatusSelect');
            if (!newStatusSelect) {
                console.error('newStatusSelect not found.');
                return;
            }
            const newStatus = newStatusSelect.value;

            currentDimpexOrder.statusDimpex = newStatus;

            let allDimpexOrders = [];
            try {
                allDimpexOrders = JSON.parse(localStorage.getItem('dimpexOrders')) || [];
            } catch (e) {
                console.error('Error parsing dimpexOrders from localStorage:', e);
                allDimpexOrders = [];
            }
            
            const orderIndex = allDimpexOrders.findIndex(order => order.id === currentDimpexOrder.id);
            if (orderIndex !== -1) {
                allDimpexOrders[orderIndex] = currentDimpexOrder;
                localStorage.setItem('dimpexOrders', JSON.stringify(allDimpexOrders));
            } else {
                allDimpexOrders.push(currentDimpexOrder);
                localStorage.setItem('dimpexOrders', JSON.stringify(allDimpexOrders));
            }

            showMessage('Sucesso', `Status do embarque ${currentDimpexOrder.shipmentName} atualizado para "${newStatus}"!`, 'success', () => {
                renderDimpexOrderDetails();
            });
            console.log('Order status saved.');
        }

        function saveShipmentDetails() {
            console.log('Saving shipment details...');
            if (!currentDimpexOrder) {
                showMessage('Erro', 'Nenhum embarque carregado para salvar os detalhes.', 'error');
                return;
            }

            currentDimpexOrder.shipmentName = safeGetValue('detailShipmentNameInput');
            currentDimpexOrder.incoterm = safeGetValue('detailIncoterm');
            currentDimpexOrder.pol = safeGetValue('detailPol');
            currentDimpexOrder.pod = safeGetValue('detailPod');
            currentDimpexOrder.prevEmbarque = safeGetValue('detailPrevEmbarque');
            currentDimpexOrder.cargoAgent = safeGetValue('detailCargoAgent');
            currentDimpexOrder.dtBooking = safeGetValue('detailDtBooking');
            currentDimpexOrder.blNumber = safeGetValue('detailBlNumber');
            currentDimpexOrder.blDate = safeGetValue('detailBlDate');
            currentDimpexOrder.dtETA = safeGetValue('detailDtETA');
            currentDimpexOrder.dtDesembaraco = safeGetValue('detailDtDesembaraco');
            currentDimpexOrder.dtFinalizado = safeGetValue('detailDtFinalizado');
            currentDimpexOrder.container20 = safeGetValue('detailCont20');
            currentDimpexOrder.container40 = safeGetValue('detailCont40');
            currentDimpexOrder.container40HQ = safeGetValue('detailCont40HQ');
            currentDimpexOrder.containerLCL = safeGetValue('detailContLCL');
            currentDimpexOrder.followUp = safeGetValue('detailFollowUp');

            let allDimpexOrders = [];
            try {
                allDimpexOrders = JSON.parse(localStorage.getItem('dimpexOrders')) || [];
            } catch (e) {
                console.error('Error parsing dimpexOrders from localStorage:', e);
                allDimpexOrders = [];
            }

            const orderIndex = allDimpexOrders.findIndex(order => order.id === currentDimpexOrder.id);
            if (orderIndex !== -1) {
                allDimpexOrders[orderIndex] = currentDimpexOrder;
                localStorage.setItem('dimpexOrders', JSON.stringify(allDimpexOrders));
            }

            showMessage('Sucesso', `Detalhes do embarque ${currentDimpexOrder.shipmentName} salvos com sucesso!`, 'success', () => {
                renderDimpexOrderDetails();
            });
            console.log('Shipment details saved.');
        }

        function revertToPurchase() {
            console.log('Reverting to purchase status...');
            if (!currentDimpexOrder) {
                showMessage('Erro', 'Nenhum embarque carregado para estornar.', 'error');
                return;
            }

            showMessage(
                'Confirmação',
                `Tem certeza que deseja estornar o embarque ${currentDimpexOrder.shipmentName} para o status "Aprovado" (Compras)?`,
                'warning',
                () => {
                    currentDimpexOrder.statusDimpex = 'Aprovado';
                    let allDimpexOrders = [];
                    try {
                        allDimpexOrders = JSON.parse(localStorage.getItem('dimpexOrders')) || [];
                    } catch (e) {
                        console.error('Error parsing dimpexOrders from localStorage:', e);
                        allDimpexOrders = [];
                    }
                    const orderIndex = allDimpexOrders.findIndex(order => order.id === currentDimpexOrder.id);
                    if (orderIndex !== -1) {
                        allDimpexOrders[orderIndex] = currentDimpexOrder;
                        localStorage.setItem('dimpexOrders', JSON.stringify(allDimpexOrders));
                    }
                    showMessage('Sucesso', `Embarque ${currentDimpexOrder.shipmentName} estornado para "Aprovado" com sucesso!`, 'success', () => {
                        showCentralPage();
                    });
                },
                () => {
                    // User cancelled, do nothing
                    console.log('Revert to purchase cancelled by user.');
                }
            );
        }

        function renderAttachedFiles() {
            console.log('Rendering attached files...');
            const ul = document.getElementById('attachedFilesList');
            if (!ul) {
                console.error('attachedFilesList not found.');
                return;
            }
            ul.innerHTML = '';

            if (!currentDimpexOrder || !currentDimpexOrder.documents || currentDimpexOrder.documents.length === 0) {
                ul.innerHTML = `<li>Nenhum arquivo anexado.</li>`;
                return;
            }

            currentDimpexOrder.documents.forEach(doc => {
                const li = document.createElement('li');
                let buttonsHtml = '';

                if (doc.content) {
                    buttonsHtml += `<button class="btn-primary" onclick="viewAttachedFile('${currentDimpexOrder.id}', '${doc.name.replace(/'/g, "\\'")}')">Visualizar</button>`;
                }

                if (doc.status === 'Recebido' && doc.content) {
                    buttonsHtml += `<button class="btn-primary" style="margin-left: 10px;" onclick="extractAttachedFile('${currentDimpexOrder.id}', '${doc.name.replace(/'/g, "\\'")}')">Extrair</button>`;
                }

                li.innerHTML = `
                    <span>${doc.name}</span>
                    <div>${buttonsHtml}</div>
                `;
                ul.appendChild(li);
            });
            console.log('Attached files rendered.');
        }

        function viewAttachedFile(orderId, docName) {
            console.log(`Viewing attached file: ${docName} for order ID: ${orderId}`);
            const order = dimpexOrders.find(o => o.id === orderId);
            if (!order) {
                showMessage('Erro', 'Embarque não encontrado para visualizar o documento.', 'error');
                return;
            }
            const doc = order.documents.find(d => d.name === docName);
            const documentViewerTitle = document.getElementById('documentViewerTitle');
            const documentViewerContent = document.getElementById('documentViewerContent');
            const documentViewerModal = document.getElementById('documentViewerModal');

            if (!documentViewerTitle || !documentViewerContent || !documentViewerModal) {
                console.error('One or more document viewer modal elements not found.');
                return;
            }

            if (doc && doc.content) {
                documentViewerTitle.innerText = doc.name;
                documentViewerContent.innerText = doc.content;
                documentViewerModal.classList.add('active');
            } else {
                showMessage('Erro', `Conteúdo do documento "${docName}" não disponível para visualização.`, 'error');
            }
        }

        function extractAttachedFile(orderId, docName) {
            console.log(`Extracting attached file: ${docName} for order ID: ${orderId}`);
            const order = dimpexOrders.find(o => o.id === orderId);
            if (!order) {
                showMessage('Erro', 'Embarque não encontrado para extrair o documento.', 'error');
                return;
            }
            const doc = order.documents.find(d => d.name === docName);
            if (doc && doc.content && doc.status === 'Recebido') {
                try {
                    const blob = new Blob([doc.content], { type: 'text/plain;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const fileName = doc.name.replace(/[^a-z0-9\s-]/gi, '').replace(/\s+/g, '-').toLowerCase() + '.txt';
                    a.download = fileName;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showMessage('Sucesso', `Documento "${docName}" extraído com sucesso!`, 'success');
                } catch (e) {
                    console.error('Erro ao extrair documento:', e);
                    showMessage('Erro', `Não foi possível extrair o documento "${docName}".`, 'error');
                }
            } else {
                showMessage('Erro', `O documento "${docName}" não pode ser extraído. Verifique se ele foi recebido e possui conteúdo.`, 'error');
            }
        }

        function closeDocumentViewerModal() {
            console.log('Closing document viewer modal.');
            const documentViewerModal = document.getElementById('documentViewerModal');
            if (documentViewerModal) {
                documentViewerModal.classList.remove('active');
            } else {
                console.warn('documentViewerModal not found when trying to close.');
            }
        }

        function renderDocumentsTable() {
            console.log('Rendering documents table...');
            const tbody = document.getElementById('documentsTableBody');
            if (!tbody) {
                console.error('documentsTableBody not found.');
                return;
            }
            tbody.innerHTML = '';

            if (!currentDimpexOrder || !currentDimpexOrder.documents || currentDimpexOrder.documents.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" style="text-align: center; padding: 15px;">Nenhum documento cadastrado para este embarque.</td></tr>`;
                return;
            }

            currentDimpexOrder.documents.forEach((doc, index) => {
                const row = document.createElement('tr');
                const actionButton = doc.status === 'Pendente' ?
                    `<button class="btn-primary" onclick="receiveDocument('${doc.name.replace(/'/g, "\\'")}', ${index})">Receber Documento</button>` :
                    `<button class="btn-secondary" disabled>Recebido</button>`;

                row.innerHTML = `
                    <td>${doc.name}</td>
                    <td><span class="status-indicator ${doc.status === 'Pendente' ? 'pending-doc' : 'doc-ok'}"></span>${doc.status}</td>
                    <td>${formatDate(doc.receivedDate)}</td>
                    <td>${actionButton}</td>
                `;
                tbody.appendChild(row);
            });
            console.log('Documents table rendered.');
        }

        function receiveDocument(docName, index) {
            console.log(`Receiving document: ${docName} at index: ${index}`);
            if (!currentDimpexOrder || !currentDimpexOrder.documents) {
                console.error('currentDimpexOrder or documents array is null/undefined.');
                return;
            }

            if (index < 0 || index >= currentDimpexOrder.documents.length) {
                console.error('Invalid document index:', index);
                return;
            }

            currentDimpexOrder.documents[index].status = 'Recebido';
            currentDimpexOrder.documents[index].receivedDate = new Date().toISOString().slice(0, 10);

            let allDimpexOrders = [];
            try {
                allDimpexOrders = JSON.parse(localStorage.getItem('dimpexOrders')) || [];
            } catch (e) {
                console.error('Error parsing dimpexOrders from localStorage:', e);
                allDimpexOrders = [];
            }
            
            const orderIndex = allDimpexOrders.findIndex(order => order.id === currentDimpexOrder.id);
            if (orderIndex !== -1) {
                allDimpexOrders[orderIndex] = currentDimpexOrder;
                localStorage.setItem('dimpexOrders', JSON.stringify(allDimpexOrders));
            }

            showMessage('Sucesso', `Documento "${docName}" recebido com sucesso!`, 'success', () => {
                renderDocumentsTable();
                renderAttachedFiles();
            });
            console.log('Document received and saved.');
        }

        function renderProductsTable() {
            console.log('Rendering products table...');
            const tbody = document.getElementById('productsTableBody');
            if (!tbody) {
                console.error('productsTableBody not found.');
                return;
            }
            tbody.innerHTML = '';

            if (!currentDimpexOrder || !currentDimpexOrder.productLines || currentDimpexOrder.productLines.length === 0) {
                tbody.innerHTML = `<tr><td colspan="12" style="text-align: center; padding: 15px;">Nenhum produto associado a este embarque.</td></tr>`;
                return;
            }

            currentDimpexOrder.productLines.forEach(product => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${product.branch || 'N/A'}</td>
                    <td>${product.boxes || 'N/A'}</td>
                    <td>${product.description || 'N/A'}</td>
                    <td>${product.item || 'N/A'}</td>
                    <td>${product.serialNumber || 'N/A'}</td>
                    <td>${(product.grossWeight !== undefined && product.grossWeight !== null) ? product.grossWeight.toFixed(2).replace('.', '.', ',') : 'N/A'}</td>
                    <td>${(product.netWeight !== undefined && product.netWeight !== null) ? product.netWeight.toFixed(2).replace('.', '.', ',') : 'N/A'}</td>
                    <td>${(product.productCode || 'N/A')}</td>
                    <td>${product.quantity || 'N/A'} ${product.unitMeasure || ''}</td>
                    <td>${(product.volumeM3 !== undefined && product.volumeM3 !== null) ? product.volumeM3.toFixed(3).replace('.', '.', ',') : 'N/A'}</td>
                    <td>R$ ${(product.prcUnit !== undefined && product.prcUnit !== null) ? product.prcUnit.toFixed(2).replace('.', '.', ',') : 'N/A'}</td>
                    <td>R$ ${(product.prcUnitFor !== undefined && product.prcUnitFor !== null) ? product.prcUnitFor.toFixed(2).replace('.', '.', ',') : 'N/A'}</td>
                `;
                tbody.appendChild(row);
            });
            console.log('Products table rendered.');
        }

        function openTab(evt, tabName) {
            console.log(`Opening tab: ${tabName}`);
            let i, tabcontent, tabbuttons;

            tabcontent = document.querySelectorAll("#dimpex-detail-page .tab-content");
            tabcontent.forEach(el => el.classList.remove("active"));

            tabbuttons = document.querySelectorAll("#dimpex-detail-page .tab-button");
            tabbuttons.forEach(el => el.classList.remove("active"));

            const targetTab = document.getElementById(tabName);
            if (targetTab) {
                targetTab.classList.add("active");
            } else {
                console.error(`Tab content with ID '${tabName}' not found.`);
            }
            
            if (evt) {
                evt.currentTarget.classList.add("active");
            } else {
                const buttonText = {
                    'tabGeral': 'Geral',
                    'tabDocumentos': 'Documentos',
                    'tabFinanceiro': 'Financeiro'
                };
                const activeButton = Array.from(tabbuttons).find(button => button.innerText.includes(buttonText[tabName]));
                if (activeButton) {
                    activeButton.classList.add('active');
                } else {
                    console.warn(`No active tab button found for tabName: ${tabName}`);
                }
            }
            console.log('Tab opened.');
        }

        function renderDashboardKPIs() {
            console.log('Rendering dashboard KPIs...');
            const totalShipmentsKPI = document.getElementById('totalShipmentsKPI');
            const inTransitShipmentsKPI = document.getElementById('inTransitShipmentsKPI');
            const customsClearanceShipmentsKPI = document.getElementById('customsClearanceShipmentsKPI');
            const deliveredShipmentsKPI = document.getElementById('deliveredShipmentsKPI');

            if (!totalShipmentsKPI || !inTransitShipmentsKPI || !customsClearanceShipmentsKPI || !deliveredShipmentsKPI) {
                console.error('One or more KPI elements not found.');
                return;
            }

            const storedAllOrders = localStorage.getItem('dimpexOrders');
            if (storedAllOrders) {
                try {
                    dimpexOrders = JSON.parse(storedAllOrders);
                    console.log('Dimpex orders loaded from localStorage.');
                } catch (e) {
                    console.error('Error parsing dimpexOrders from localStorage:', e);
                    dimpexOrders = initialDimpexOrders; // Fallback to initial data on parse error
                }
            } else {
                dimpexOrders = initialDimpexOrders;
                localStorage.setItem('dimpexOrders', JSON.stringify(initialDimpexOrders));
                console.log('Initial Dimpex orders set and saved to localStorage.');
            }

            const totalShipments = dimpexOrders.length;
            const inTransitShipments = dimpexOrders.filter(order => order.statusDimpex === 'Em Trânsito').length;
            const customsClearanceShipments = dimpexOrders.filter(order => order.statusDimpex === 'Chegada no Porto de Destino (ATA)').length; /* Changed to ATA as per flow */
            const deliveredShipments = dimpexOrders.filter(order => order.statusDimpex === 'Entrega ao Cliente').length;

            totalShipmentsKPI.innerText = totalShipments;
            inTransitShipmentsKPI.innerText = inTransitShipments;
            customsClearanceShipmentsKPI.innerText = customsClearanceShipments;
            deliveredShipmentsKPI.innerText = deliveredShipments;
            console.log('Dashboard KPIs rendered.');
        }

        // Function to generate the Customer Follow Up document as PDF
        async function generatePdfFollowUp() {
            console.log('Attempting to generate PDF...');
            if (!currentDimpexOrder) {
                showMessage('Erro', 'Nenhum embarque selecionado para gerar o documento.', 'error');
                return;
            }

            const pdfContentContainer = document.getElementById('pdfContentContainer');
            const pdfViewerModal = document.getElementById('pdfViewerModal');
            const pdfFrame = document.getElementById('pdfFrame');

            if (!pdfContentContainer || !pdfViewerModal || !pdfFrame) {
                console.error('One or more PDF related elements not found (pdfContentContainer, pdfViewerModal, or pdfFrame).');
                showMessage('Erro', 'Erro interno: Elementos do visualizador de PDF não encontrados.', 'error');
                return;
            }
            
            // Temporarily make the container visible for html2canvas
            pdfContentContainer.style.display = 'block';
            console.log('pdfContentContainer set to display: block.');

            // Populate the hidden PDF content container
            const setText = (id, value) => {
                const element = pdfContentContainer.querySelector(`#${id}`);
                if (element) {
                    element.innerText = value !== undefined && value !== null ? value : 'N/A';
                } else {
                    console.warn(`Element with ID '${id}' not found in PDF container.`);
                }
            };

            console.log("Populating PDF content for order:", currentDimpexOrder.id);

            setText('pdfDocReadyDate', formatDate(currentDimpexOrder.prevEmbarque));
            setText('pdfDocTerms', currentDimpexOrder.incoterm);
            setText('pdfDocPol', currentDimpexOrder.pol);
            setText('pdfDocConsignee', currentDimpexOrder.cliente);
            setText('pdfDocPoC', currentDimpexOrder.poCliente);
            setText('pdfDocPiC', currentDimpexOrder.numeroCI);
            setText('pdfDocPod', currentDimpexOrder.pod);
            setText('pdfDocFollowUp', currentDimpexOrder.followUp);
            setText('pdfDocTtAmount', `R$ ${parseFloat(currentDimpexOrder.titCliente || 0).toFixed(2).replace('.', ',', '.')}`);
            setText('pdfDocDownPayment', `R$ ${parseFloat(currentDimpexOrder.pgAntecipCR || 0).toFixed(2).replace('.', ',', '.')}`);
            setText('pdfDocDownPaymentDate', formatDate(currentDimpexOrder.dtPgAntCR));
            setText('pdfDocBalancePayment', `R$ ${parseFloat(currentDimpexOrder.pgSaldoCR || 0).toFixed(2).replace('.', ',', '.')}`);
            setText('pdfDocBalancePaymentDate', formatDate(currentDimpexOrder.dtPgSalCR));
            setText('pdfDocCi', currentDimpexOrder.numeroCI);
            
            let containerInfo = [];
            if (currentDimpexOrder.container20 && parseInt(currentDimpexOrder.container20) > 0) containerInfo.push(`${currentDimpexOrder.container20}x20'`);
            if (currentDimpexOrder.container40 && parseInt(currentDimpexOrder.container40) > 0) containerInfo.push(`${currentDimpexOrder.container40}x40'`);
            if (currentDimpexOrder.container40HQ && parseInt(currentDimpexOrder.container40HQ) > 0) containerInfo.push(`${currentDimpexOrder.container40HQ}x40'HQ`);
            if (currentDimpexOrder.containerLCL && parseInt(currentDimpexOrder.containerLCL) > 0) containerInfo.push(`LCL`);
            setText('pdfDocContainer', containerInfo.join(', ') || 'N/A');

            setText('pdfDocSerialNumbers', currentDimpexOrder.serialNum);
            setText('pdfDocForwarder', currentDimpexOrder.cargoAgent);
            setText('pdfDocTelexRelease', currentDimpexOrder.telexRelease);
            setText('pdfDocEtd', formatDate(currentDimpexOrder.prevEmbarque));
            setText('pdfDocCoo', currentDimpexOrder.certOrigem);
            setText('pdfDocAtd', formatDate(currentDimpexOrder.blDate));
            setText('pdfDocBl', currentDimpexOrder.blNumber);
            setText('pdfDocEta', formatDate(currentDimpexOrder.dtETA));

            const productsTableBody = pdfContentContainer.querySelector('#pdfProductsTableBodyDoc');
            if (productsTableBody) {
                productsTableBody.innerHTML = '';
                if (currentDimpexOrder.productLines && currentDimpexOrder.productLines.length > 0) {
                    currentDimpexOrder.productLines.forEach(product => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${product.productCode || 'N/A'}</td>
                            <td>${product.description || 'N/A'}</td>
                            <td class="qty">${product.quantity || 'N/A'}</td>
                            <td class="pkgs">${product.boxes || 'N/A'}</td>
                            <td class="nw">${(product.netWeight !== undefined && product.netWeight !== null) ? product.netWeight.toFixed(2).replace('.', ',', '.') : 'N/A'}</td>
                            <td class="gw">${(product.grossWeight !== undefined && product.grossWeight !== null) ? product.grossWeight.toFixed(2).replace('.', ',', '.') : 'N/A'}</td>
                            <td class="cbm">${(product.volumeM3 !== undefined && product.volumeM3 !== null) ? product.volumeM3.toFixed(3).replace('.', ',', '.') : 'N/A'}</td>
                        `;
                        productsTableBody.appendChild(row);
                    });
                } else {
                    productsTableBody.innerHTML = `<tr><td colspan="7" style="text-align: center;">Nenhum produto cadastrado para este embarque.</td></tr>`;
                }
            } else {
                console.warn('pdfProductsTableBodyDoc not found in PDF container.');
            }

            // Options for PDF generation
            const options = {
                margin: 10, // Keep a reasonable margin
                filename: `documento_acompanhamento_${currentDimpexOrder.id}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 1, logging: true, dpi: 192, letterRendering: true, useCORS: true, allowTaint: true }, // Scale set to 1
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait', hotfixes: ['px_scaling'] }, // Added hotfixes
                pagebreak: { mode: 'avoid-all' } // Avoid page breaks within elements
            };

            // Generate PDF and open in new tab
            try {
                console.log('Calling html2pdf()...');
                const pdfDataUri = await html2pdf().set(options).from(pdfContentContainer).outputPdf('datauristring');
                console.log('PDF data URI string generated. Setting iframe src...');
                
                pdfFrame.src = pdfDataUri; // Set the data URI to the iframe's src
                pdfViewerModal.classList.add('active'); // Show the modal
                // Removed: showMessage('Sucesso', 'PDF gerado e aberto no visualizador!', 'success');
            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                showMessage('Erro', 'Ocorreu um erro ao gerar o PDF. Por favor, tente novamente.', 'error');
            } finally {
                // Hide the container again after PDF generation
                pdfContentContainer.style.display = 'none';
                console.log('pdfContentContainer set back to display: none.');
            }
        }

        function closePdfViewerModal() {
            console.log('Closing PDF viewer modal.');
            const pdfViewerModal = document.getElementById('pdfViewerModal');
            const pdfFrame = document.getElementById('pdfFrame');
            if (pdfViewerModal) {
                pdfViewerModal.classList.remove('active');
            }
            if (pdfFrame) {
                pdfFrame.src = ''; // Clear the iframe src to prevent memory leaks
            }
        }

        // Function to simulate sending PDF by email
        function sendPdfByEmail() {
            if (!currentDimpexOrder) {
                showMessage('Erro', 'Nenhum embarque selecionado para enviar o PDF.', 'error');
                return;
            }
            showMessage('Sucesso', `PDF do embarque ${currentDimpexOrder.shipmentName} simulado como enviado por e-mail!`, 'success', () => {
                closePdfViewerModal();
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOMContentLoaded event fired. Initializing app...');
            const storedAllOrders = localStorage.getItem('dimpexOrders');
            if (storedAllOrders) {
                try {
                    dimpexOrders = JSON.parse(storedAllOrders);
                    console.log('Dimpex orders loaded from localStorage.');
                } catch (e) {
                    console.error('Error parsing dimpexOrders from localStorage on DOMContentLoaded:', e);
                    dimpexOrders = initialDimpexOrders; // Fallback to initial data on parse error
                }
            } else {
                dimpexOrders = initialDimpexOrders;
                localStorage.setItem('dimpexOrders', JSON.stringify(initialDimpexOrders));
                console.log('Initial Dimpex orders set and saved to localStorage.');
            }
            showCentralPage();
            console.log('App initialization complete.');
        });
    </script>
</body>
</html>
